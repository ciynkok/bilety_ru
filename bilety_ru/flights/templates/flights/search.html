{% extends 'user_management/base.html'%}

{% block style %}
    .autocomplete {
            position: relative;
            display: inline-block;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
{% endblock %}

{% block content %}
<form method="post" id="cityForm">
    {% csrf_token %}
    <div>
        {{ form.currencyCode }}
    </div>
    <div class="autocomplete">
        {{ form.originCity }}
<!--        <input type="text" id="originCity" placeholder="Введите город отправления...">-->
        <div id="originList" class="autocomplete-items"></div>
    </div>
    <div class="autocomplete">
        {{ form.destinationCity }}
<!--        <input type="text" id="destinationCity" placeholder="Введите город прибытия...">-->
        <div id="destinationList" class="autocomplete-items"></div>
    </div>
    <div>
        {{ form.departureDate }}
    </div>
    <div>
        {{ form.returnDate }}
    </div>
    <div>
        {{ form.adults }}
    </div>
    <button type="submit">Найти</button>
</form>
<p>
    {{ form_data }}
</p>
<script>
alert('err');
document.addEventListener('DOMContentLoaded', func_list('id_originCity', 'originList'));
document.addEventListener('DOMContentLoaded', func_list('id_destinationCity', 'destinationList'));
function func_list(id_input, id_list) {
    const input = document.getElementById(id_input);
    const autocompleteList = document.getElementById(id_list);
    let currentFocus = -1;

    input.addEventListener('input', function(e) {
        const query = e.target.value;

        if (query.length < 2) {
            closeAllLists();
            return;
        }

        fetch(`/api_airport_search/?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                showSuggestions(data);
            });
    });

    input.addEventListener('keydown', function(e) {
        const items = autocompleteList.getElementsByTagName('div');

        if (e.keyCode === 40) {
            currentFocus++;
            addActive(items);
        } else if (e.keyCode === 38) {
            currentFocus--;
            addActive(items);
        } else if (e.keyCode === 13) { // Enter
            e.preventDefault();
            if (currentFocus > -1) {
                if (items) items[currentFocus].click();
            }
        }
    });

    function showSuggestions(items) {
        closeAllLists();
        currentFocus = -1;

        if (!items || items.length === 0) return;

        items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.innerHTML = `<strong>${item.substr(0, input.value.length)}</strong>${item.substr(input.value.length)}`;
            itemElement.innerHTML += `<input type='hidden' value='${item}'>`;

            itemElement.addEventListener('click', function() {
                input.value = this.getElementsByTagName('input')[0].value;
                closeAllLists();
            });

            autocompleteList.appendChild(itemElement);
        });
    }

    function addActive(items) {
        if (!items) return false;

        removeActive(items);

        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (items.length - 1);

        items[currentFocus].classList.add('autocomplete-active');
    }

    function removeActive(items) {
        for (let i = 0; i < items.length; i++) {
            items[i].classList.remove('autocomplete-active');
        }
    }

    function closeAllLists() {
        const items = autocompleteList.getElementsByTagName('div');
        for (let i = 0; i < items.length; i++) {
            items[i].parentNode.removeChild(items[i]);
        }
    }

    document.addEventListener('click', function(e) {
        if (e.target !== input) {
            closeAllLists();
        }
    });

}
</script>
{% endblock %}