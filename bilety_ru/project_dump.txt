Структура папок
D:.
│   Airline_review.csv
│   db.sqlite3
│   manage.py
│   project_dump.txt
│   recsys_model.pth
│   
├───api
│   │   admin.py
│   │   apps.py
│   │   models.py
│   │   tests.py
│   │   urls.py
│   │   views.py
│   │   __init__.py
│   │   
│   ├───migrations
│   │   │   0001_initial.py
│   │   │   __init__.py
│   │   │   
│   │   └───__pycache__
│   │           0001_initial.cpython-312.pyc
│   │           0002_rename_iatacode_iata_iata_iata_name_iata_state_and_more.cpython-312.pyc
│   │           __init__.cpython-312.pyc
│   │           
│   └───__pycache__
│           admin.cpython-312.pyc
│           apps.cpython-311.pyc
│           apps.cpython-312.pyc
│           models.cpython-312.pyc
│           urls.cpython-312.pyc
│           views.cpython-312.pyc
│           __init__.cpython-311.pyc
│           __init__.cpython-312.pyc
│           
├───bilety_ru
│   │   asgi.py
│   │   settings.py
│   │   urls.py
│   │   wsgi.py
│   │   __init__.py
│   │   
│   └───__pycache__
│           settings.cpython-310.pyc
│           settings.cpython-311.pyc
│           settings.cpython-312.pyc
│           urls.cpython-311.pyc
│           urls.cpython-312.pyc
│           wsgi.cpython-312.pyc
│           __init__.cpython-310.pyc
│           __init__.cpython-311.pyc
│           __init__.cpython-312.pyc
│           
├───booking
│   │   admin.py
│   │   apps.py
│   │   email_sender.py
│   │   models.py
│   │   tests.py
│   │   urls.py
│   │   views.py
│   │   __init__.py
│   │   
│   ├───migrations
│   │   │   __init__.py
│   │   │   
│   │   └───__pycache__
│   │           __init__.cpython-312.pyc
│   │           
│   ├───static
│   │   └───booking
│   │       ├───css
│   │       │       base.css
│   │       │       booking.css
│   │       │       
│   │       └───js
│   │               booking.js
│   │               
│   ├───templates
│   │   └───booking
│   │           base.html
│   │           booking.html
│   │           booking_data.html
│   │           booking_success.html
│   │           
│   └───__pycache__
│           admin.cpython-312.pyc
│           apps.cpython-311.pyc
│           apps.cpython-312.pyc
│           email_sender.cpython-312.pyc
│           models.cpython-312.pyc
│           urls.cpython-312.pyc
│           views.cpython-311.pyc
│           views.cpython-312.pyc
│           __init__.cpython-311.pyc
│           __init__.cpython-312.pyc
│           
├───flights
│   │   admin.py
│   │   apps.py
│   │   forms.py
│   │   models.py
│   │   scheduler_jobs.py
│   │   tasks.py
│   │   tests.py
│   │   urls.py
│   │   views.py
│   │   __init__.py
│   │   
│   ├───management
│   │   └───commands
│   │       │   export_booking_data.py
│   │       │   train_recsys.py
│   │       │   
│   │       └───__pycache__
│   │               export_booking_data.cpython-312.pyc
│   │               train_recsys.cpython-312.pyc
│   │               __init__.cpython-312.pyc
│   │               
│   ├───migrations
│   │   │   0001_initial.py
│   │   │   0002_initial.py
│   │   │   0003_airlineraiting.py
│   │   │   0004_alter_airlineraiting_airline_code.py
│   │   │   0005_flightsegment_airlineraiting.py
│   │   │   __init__.py
│   │   │   
│   │   └───__pycache__
│   │           0001_initial.cpython-312.pyc
│   │           0002_booking.cpython-312.pyc
│   │           0002_flightoffer_oneway_flightrequest_sortparam_and_more.cpython-312.pyc
│   │           0002_initial.cpython-312.pyc
│   │           0003_airlineraiting.cpython-312.pyc
│   │           0003_rename_travalclass_flightrequest_travelclass_and_more.cpython-312.pyc
│   │           0004_alter_airlineraiting_airline_code.cpython-312.pyc
│   │           0004_iata_jsonbuffer.cpython-312.pyc
│   │           0005_flightsegment_airlineraiting.cpython-312.pyc
│   │           0005_rename_iata_code_iata_iata_iata_city_iata_state.cpython-312.pyc
│   │           0006_alter_iata_city_alter_iata_name_alter_iata_state.cpython-312.pyc
│   │           0007_delete_iata_delete_jsonbuffer.cpython-312.pyc
│   │           0007_delete_iata_delete_jsonbuffer_and_more.cpython-312.pyc
│   │           0008_delete_iata_delete_jsonbuffer.cpython-312.pyc
│   │           0008_delete_iata_delete_jsonbuffer_and_more.cpython-312.pyc
│   │           0008_remove_iata_city_remove_iata_iata_remove_iata_state_and_more.cpython-312.pyc
│   │           0009_delete_iata_delete_jsonbuffer_and_more.cpython-312.pyc
│   │           0009_flightsegment_aircraftcode.cpython-312.pyc
│   │           0009_iata_jsonbuffer.cpython-312.pyc
│   │           __init__.cpython-312.pyc
│   │           
│   ├───recsys
│   │   │   model_stub.py
│   │   │   predictor.py
│   │   │   
│   │   └───__pycache__
│   │           model_stub.cpython-312.pyc
│   │           predictor.cpython-312.pyc
│   │           
│   ├───static
│   │   └───flights
│   │       ├───css
│   │       │       base.css
│   │       │       search.css
│   │       │       
│   │       └───js
│   │               search.js
│   │               
│   ├───templates
│   │   └───flights
│   │           base.html
│   │           search.html
│   │           test.html
│   │           
│   └───__pycache__
│           admin.cpython-312.pyc
│           apps.cpython-311.pyc
│           apps.cpython-312.pyc
│           flight.cpython-312.pyc
│           forms.cpython-312.pyc
│           models.cpython-311.pyc
│           models.cpython-312.pyc
│           urls.cpython-312.pyc
│           views.cpython-312.pyc
│           __init__.cpython-311.pyc
│           __init__.cpython-312.pyc
│           
├───recsys_data
│       bookings.csv
│       offers.csv
│       users.csv
│       
└───user_management
    │   admin.py
    │   apps.py
    │   forms.py
    │   models.py
    │   tests.py
    │   urls.py
    │   views.py
    │   __init__.py
    │   
    ├───migrations
    │   │   0001_initial.py
    │   │   0002_remove_customuser_username_alter_customuser_email.py
    │   │   0003_alter_customuser_managers.py
    │   │   0004_alter_customuser_mfa_secret.py
    │   │   __init__.py
    │   │   
    │   └───__pycache__
    │           0001_initial.cpython-312.pyc
    │           0002_remove_customuser_username_alter_customuser_email.cpython-312.pyc
    │           0003_alter_customuser_managers.cpython-312.pyc
    │           0004_alter_customuser_mfa_secret.cpython-312.pyc
    │           __init__.cpython-312.pyc
    │           
    ├───static
    │   └───user_management
    │           qr_code.png
    │           style.css
    │           
    ├───templates
    │   └───user_management
    │           auth.html
    │           base.html
    │           otp_verify.html
    │           profile.html
    │           qrCodePage.html
    │           signup.html
    │           
    └───__pycache__
            admin.cpython-312.pyc
            apps.cpython-311.pyc
            apps.cpython-312.pyc
            forms.cpython-312.pyc
            models.cpython-312.pyc
            urls.cpython-312.pyc
            views.cpython-312.pyc
            __init__.cpython-311.pyc
            __init__.cpython-312.pyc

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\migrations\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\admin.py
=============================
from django.contrib import admin
from .models import IATA

# Register your models here.
admin.site.register(IATA)

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\apps.py
=============================
from django.apps import AppConfig


class ApiConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'api'

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\models.py
=============================
from django.db import models


class IATA(models.Model):
    iata = models.CharField(max_length=3)
    name = models.CharField(max_length=100)
    city = models.CharField(max_length=100)
    state = models.CharField(max_length=100)

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\tests.py
=============================
from django.test import TestCase

# Create your tests here.

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\urls.py
=============================
from django.urls import path
from . import views

app_name = 'api'

urlpatterns = [
    path('cities/', views.get_cities, name='get_cities'),
    path('airports/', views.SearchAirports.as_view(), name='search_airports'),
    #path('get-rating/', views.GetRating.as_view(), name='get_rating'),
    #path('flight-offers/', views.get_structured_flight_offers, name='get_structured_flight_offers'),
    path('check-price/<int:offer_id>/', views.CheckPriceView.as_view(), name='check_flight_price'),
    #path('flight-details/<int:offer_id>/', views.get_flight_details, name='get_flight_details'),
    #path('create-order/<int:offer_id>/', views.create_flight_order, name='create_flight_order'),
    #path('order/<str:order_id>/', views.get_order_info, name='get_order_info'),
    #path('flight-prices/', views.Index.as_view(), name='get_flight_prices')
]

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\views.py
=============================
from django.shortcuts import render
import amadeus
from django.http import JsonResponse
from django.utils import timezone
from django.forms.models import model_to_dict
from flights.models import FlightRequest, FlightOffer, FlightSegment, AirLineRaiting
from .models import IATA
import isodate
import datetime
import json
import requests
from django.views.decorators.csrf import csrf_exempt
from rest_framework.views import APIView
from rest_framework.response import Response
import datetime
from dotenv import load_dotenv
import os

load_dotenv()

c = amadeus.Client(client_id=os.getenv('API_KEY'),
                   client_secret=os.getenv('API_SECRET'))


def get_cities(request):
    query = request.GET.get("query", None)  # Получаем введённый текст
    data = c.reference_data.locations.get(keyword=query, subType=amadeus.Location.ANY).data
    result = []
    for i, val in enumerate(data):
        result.append(data[i]['iataCode']+', '+data[i]['name'])
    return JsonResponse(result, safe=False)


def offer_search_api(flight_req_id):
    
    try:
        # Проверяем существование запроса
        flight_req = FlightRequest.objects.get(id=flight_req_id)

        # Преобразуем модель в словарь для передачи в API
        kwargs = model_to_dict(flight_req)
        d = {}
        for key in kwargs.keys():
           if kwargs[key] is not None and key not in ['id', 'user', 'session_key', 'created_at', 'nonStop', 'sortParam']:
              d[key] = kwargs[key]
        
        # Ограничиваем количество результатов
        d['max'] = 2
        
        # Выполняем поиск рейсов

        search_flights = c.shopping.flight_offers_search.get(**d)

        # Проверяем, есть ли результаты
        if not search_flights.data:
            print(f"No flights found for request ID: {flight_req_id}")
            return False
            
        # Обрабатываем каждый найденный рейс
        for flight in search_flights.data:
            # Получаем первый и последний сегменты для определения общего времени полета
            if not flight.get('itineraries') or not flight['itineraries'][0].get('segments'):
                continue  # Пропускаем рейс без сегментов
                
            segment1 = flight['itineraries'][0]['segments'][0]
            segment_last = flight['itineraries'][0]['segments'][-1]
            
            # Парсим продолжительность полета
            try:
                duration = isodate.parse_duration(flight['itineraries'][0]['duration'])
                duration = datetime.time(hour=duration.seconds//3600, minute=duration.seconds//60 % 60)
            except (ValueError, TypeError) as e:
                print(f"Error parsing duration: {e}")
                duration = datetime.time(0, 0)  # Устанавливаем значение по умолчанию
            
            # Создаем предложение рейса
            
            offer = FlightOffer(
                flightRequest=flight_req,
                adults_count=flight_req.adults,
                dep_duration=isodate.parse_datetime(segment1['departure']['at']),
                arr_duration=isodate.parse_datetime(segment_last['arrival']['at']),
                duration=duration,
                currencyCode=flight['price']['currency'],
                totalPrice=flight['price']['total'],
                oneWay=False if len(flight['itineraries']) > 1 else True,
                data=flight,
            )
            # Проверяем наличие атрибутов children и infants у объекта flight_req
            if hasattr(flight_req, 'children') and flight_req.children is not None:
                offer.children_count = flight_req.children
            if hasattr(flight_req, 'infants') and flight_req.infants is not None:
                offer.infants_count = flight_req.infants
            offer.save()
            
            
            # Обрабатываем каждый сегмент рейса
            for i in range(len(flight['itineraries'])):
                for segment in flight['itineraries'][i]['segments']:
                    # Парсим продолжительность сегмента
                    try:
                        duration_seg = isodate.parse_duration(segment['duration'])
                        duration_seg = datetime.time(
                            hour=duration_seg.seconds // 3600, 
                            minute=duration_seg.seconds // 60 % 60
                        )
                    except (ValueError, TypeError) as e:
                        print(f"Error parsing segment duration: {e}")
                        duration_seg = datetime.time(0, 0)  # Устанавливаем значение по умолчанию
                    #print(segment)
                    dep_terminal = '' if not('terminal' in segment['departure']) else segment['departure']['terminal']
                    arr_terminal = '' if not('terminal' in segment['arrival']) else segment['arrival']['terminal']
                    FlightSegment(
                        offer=offer,
                        there_seg=True if i == 0 else False,
                        dep_iataCode=segment['departure']['iataCode'],
                        dep_airport=getAirport(segment['departure']['iataCode']),
                        dep_terminal=dep_terminal,
                        dep_dateTime=isodate.parse_datetime(segment['departure']['at']),
                        arr_iataCode=segment['arrival']['iataCode'],
                        arr_airport=getAirport(segment['arrival']['iataCode']),
                        arr_terminal=arr_terminal,
                        arr_dateTime=isodate.parse_datetime(segment['arrival']['at']),
                        carrierCode=segment['carrierCode'],
                        airlineRaiting=get_rating(segment['carrierCode']),
                        number=segment['number'],
                        aircraftCode=segment['aircraft']['code'],
                        operating=segment['operating']['carrierCode'],
                        duration=duration_seg
                    ).save()
                    #print('success')
        return True
    except FlightRequest.DoesNotExist:
        print(f"FlightRequest with ID {flight_req_id} does not exist")
        return False
    except Exception as e:
        print(f"Error in offer_search_api: {e}")
        return False

'''   
def process_flight_data(flight_data):
    """
    Обрабатывает сырые данные от API и извлекает нужную информацию
    """
    processed_flights = []
    
    for offer in flight_data.get('data', []):
        # Обрабатываем сегменты перелета
        itineraries = []
        for itinerary in offer['itineraries']:
            segments = []
            for segment in itinerary['segments']:
                segments.append({
                    'departure_airport': segment['departure']['iataCode'],
                    'arrival_airport': segment['arrival']['iataCode'],
                    'departure_time': segment['departure']['at'],
                    'arrival_time': segment['arrival']['at'],
                    'airline': segment['carrierCode'],
                    'flight_number': segment['number']
                })
            
            itineraries.append({
                'duration': itinerary['duration'],
                'segments': segments
            })

        # Информация о цене
        price_info = {
            'total': offer['price']['total'],
            'currency': offer['price']['currency']
        }

        processed_flights.append({
            'itineraries': itineraries,
            'price': price_info,
            'one_way': len(itineraries) == 1
        })
    
    return processed_flights
'''

def transform_airport(airport):
    airport = list(airport)
    for i in range(1, len(airport)):
        if airport[i - 1] == ' ':
            continue
        airport[i] = airport[i].lower()
    airport = ''.join(airport)
    return airport


def getAirport(iataCode):
    data = IATA.objects.get(iata=iataCode)
    return data.city


class SearchAirports(APIView):
    def get(self, request):
        keyword = request.GET.get('keyword', '')
        if not keyword or len(keyword) < 1:
            return JsonResponse({
                'success': False,
                'error': 'Keyword parameter is required'
            }, status=400)
        
        response = c.reference_data.locations.get(keyword=keyword, subType=amadeus.Location.AIRPORT)
        if response.data:
            data = response.data
            airports = []
            if len(data) > 0:
                for item in data:
                    airport = {
                        'iataCode': item['iataCode'],
                        'cityName': transform_airport(item['address']['cityName'])
                    }
                    airports.append(airport)
            return JsonResponse({
                'success': True,
                'airports': airports
            })
        else:
            return JsonResponse({
                'success': False,
                'error': 'Airports not found'
            }, status=404)


class CheckPriceView(APIView):
    def get(self, request, offer_id):
        offer = FlightOffer.objects.get(id=offer_id)
        try:
            #print(1)
            #print(offer.data)
            response = c.shopping.flight_offers.pricing.post(offer.data)
            #print(response.data)
            #print(response.data['flightOffers'][0]['price']['total'])
            if response and 'flightOffers' in response.data and len(response.data['flightOffers']) > 0:
                current_price = float(response.data['flightOffers'][0]['price']['total'])
                return JsonResponse({
                    'success': True,
                    'price': current_price,
                    'currency': offer.currencyCode or 'EUR'
                })
            else:
                return JsonResponse({
                    'success': False,
                    'error': 'Flight not found'
                }, status=404)
        except Exception as e:
            return JsonResponse({
                'success': False,
                'error': str(e)
            }, status=500)


def capitalize_words(text: str) -> str:
    return " ".join(word.capitalize() for word in text.split())


def get_rating(iataCode):

    exists = AirLineRaiting.objects.filter(airline_code = iataCode).exists()

    if exists:
        return AirLineRaiting.objects.get(airline_code = iataCode)
    else:
        data = c.reference_data.airlines.get(airlineCodes=iataCode)
        print(data.data[0]['businessName'])
        airlineName = capitalize_words(data.data[0]['businessName'])
        airlineRating = AirLineRaiting.objects.get(airline_name = airlineName)
        airlineRating.airline_code = iataCode
        airlineRating.save()
        return airlineRating
        

'''
def check_flight_price(request, offer_id):
    """
    API для проверки актуальной цены рейса через Amadeus API
    """
    try:
        # Получаем предложение по ID
        offer = FlightOffer.objects.get(id=offer_id)
        #print(offer.data)
        # Формируем параметры для запроса
        #params = {'data': {'type': 'flight-offers-pricing', 'flightOffers': [offer.data]}}
        try:
            response = c.shopping.flight_offers.pricing.post(offer.data)
        except Exception as e:
            print(e)
        # Проверяем статус ответа
        #print(response.keys())
        #print(response)
        if response:
            # Проверяем, есть ли предложения в ответе
            if 'flightOffers' in response.data and len(response.data['flightOffers']) > 0:
                # Получаем актуальную цену
                current_price = float(response.data['flightOffers'][0]['price']['total'])
                
                # Обновляем цену в базе данных
                old_price = float(offer.totalPrice)
                offer.totalPrice = current_price
                offer.save()
                
                # Возвращаем актуальную цену и разницу с предыдущей
                price_diff = current_price - old_price
                return JsonResponse({
                    'success': True,
                    'price': current_price,
                    'old_price': old_price,
                    'price_diff': price_diff,
                    'currency': offer.currencyCode or 'EUR',
                })
                
            else:
                return JsonResponse({
                    'success': False,
                    'error': 'Flight not found',
                    'redirect': True,
                    'redirect_url': '/'
                })
        else:
            # В случае ошибки API, возвращаем текущую цену из базы
            return JsonResponse({
                'success': False,
                'error': f'Amadeus API error: {response.status_code}',
                'price': float(offer.totalPrice),
                'currency': offer.currencyCode or 'EUR'
            })
    
    except FlightOffer.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': 'Offer not found',
            'redirect': True,
            'redirect_url': '/'
        }, status=404)
    
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)


def create_flight_order(request, offer_id):
    """
    API endpoint для создания заказа через Amadeus Flight Create Orders
    """
    if request.method != 'POST':
        return JsonResponse({'error': 'Only POST method is allowed'}, status=405)
    
    try:
        data = json.loads(request.body)
        offer = FlightOffer.objects.get(id=offer_id)
        
        # Подготавливаем данные для запроса к Amadeus API
        order_request = {
            'data': {
                'type': 'flight-order',
                'flightOffers': [offer.data],
                'travelers': data.get('travelers', []),
                'remarks': {
                    'general': [
                        {
                            'subType': 'GENERAL_MISCELLANEOUS',
                            'text': 'ONLINE BOOKING FROM BILETY.RU'
                        }
                    ]
                },
                'ticketingAgreement': {
                    'option': 'DELAY_TO_CANCEL',
                    'delay': '6D'
                },
                'contacts': data.get('contacts', [])
            }
        }
        
        # Выполняем запрос к Amadeus API для создания заказа
        order_response = c.booking.flight_orders.post(order_request)
        
        # Возвращаем данные о созданном заказе
        return JsonResponse({
            'success': True,
            'order': order_response['data']
        })
    
    except FlightOffer.DoesNotExist:
        return JsonResponse({'error': 'Flight offer not found'}, status=404)
    except json.JSONDecodeError:
        return JsonResponse({'error': 'Invalid JSON data'}, status=400)
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)
    

def get_order_info(request, order_id):
    """
    API для получения информации о заказе по его ID
    """
    try:
        # Запрашиваем информацию о заказе через Amadeus API
        order_response = c.booking.flight_orders(order_id).get()
        order_data = order_response['data']
        
        # Извлекаем основную информацию о заказе
        flight_offers = order_data.get('flightOffers', [])
        travelers = order_data.get('travelers', [])
        
        if not flight_offers:
            return JsonResponse({'error': 'No flight offers found in order'}, status=404)
        
        # Получаем информацию о маршруте из первого предложения
        first_offer = flight_offers[0]
        first_segment = first_offer['itineraries'][0]['segments'][0]
        last_segment = first_offer['itineraries'][0]['segments'][-1]
        
        # Получаем названия городов
        try:
            origin_city = c.reference_data.locations.get(
                keyword=first_segment['departure']['iataCode'], 
                subType=amadeus.Location.CITY
            ).data[0]['name']
            
            destination_city = c.reference_data.locations.get(
                keyword=last_segment['arrival']['iataCode'], 
                subType=amadeus.Location.CITY
            ).data[0]['name']
        except Exception:
            # В случае ошибки используем коды IATA
            origin_city = first_segment['departure']['iataCode']
            destination_city = last_segment['arrival']['iataCode']
        
        # Форматируем дату вылета
        departure_datetime = datetime.datetime.fromisoformat(first_segment['departure']['at'].replace('Z', '+00:00'))
        departure_date = departure_datetime.strftime('%d.%m.%Y %H:%M')
        
        # Собираем структурированный ответ
        response_data = {
            'id': order_id,
            'origin': origin_city,
            'destination': destination_city,
            'departureDate': departure_date,
            'passengerCount': len(travelers),
            'totalPrice': first_offer['price']['total'],
            'currencyCode': first_offer['price']['currency'],
            'status': order_data.get('status', 'UNKNOWN')
        }
        
        return JsonResponse(response_data)
    
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)
'''

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\api\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\bilety_ru\asgi.py
=============================
"""
ASGI config for bilety_ru project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bilety_ru.settings')

application = get_asgi_application()

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\bilety_ru\settings.py
=============================
"""
Django settings for bilety_ru project.

Generated by 'django-admin startproject' using Django 4.2.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/4.2/ref/settings/
"""

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/4.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-8$0#@%-178r5#ba7)g^gc*)83n6)1vd*#h7(268ui&o980uy6p'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'user_management',
    'flights',
    'api',
    'booking',
    'django_apscheduler',
    #'django_otp',                                  # Основное приложение для работы с OTP
    #'django_otp.plugins.otp_static',               # Поддержка статических кодов
    #'django_otp.plugins.otp_totp',                 # Поддержка TOTP (Time-based One-Time Password)
    #'two_factor',                                  # Приложение двухфакторной аутентификации
    #'crispy_forms',                                # Для красивых форм
    #'crispy_bootstrap5',    
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'bilety_ru.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'bilety_ru.wsgi.application'


# Database
# https://docs.djangoproject.com/en/4.2/ref/settings/#databases
'''
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'bilety_ru',
        'USER': 'postgres',
        'PASSWORD': '0915',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
'''
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Password validation
# https://docs.djangoproject.com/en/4.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

AUTH_USER_MODEL = "user_management.CustomUser"

LOGIN_URL = 'user_management:signin'
LOGIN_REDIRECT_URL = 'flights:home'
LOGOUT_REDIRECT_URL = 'flights:home'

# Internationalization
# https://docs.djangoproject.com/en/4.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = False


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.2/howto/static-files/

STATIC_URL = 'static/'

RECSYS_MODEL_PATH = BASE_DIR / 'recsys_model.pth'
RECSYS_DATA_DIR = BASE_DIR / 'recsys_data'

# Default primary key field type
# https://docs.djangoproject.com/en/4.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
'''
from dotenv import load_dotenv
import os

load_dotenv()

EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.mail.ru'
EMAIL_PORT = 587  # или 465 для SSL
EMAIL_USE_TLS = True  # или EMAIL_USE_SSL = True, если используете SSL
EMAIL_HOST_USER = os.getenv('EMAIL')
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_PASSWORD')
DEFAULT_FROM_EMAIL = f'bilety_ru {os.getenv('GMAIL')}'

TWO_FACTOR_EMAIL_GATEWAY = 'two_factor.gateways.email.EmailDevice'
'''

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\bilety_ru\urls.py
=============================
"""
URL configuration for bilety_ru project.

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/4.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include
from booking import views as booking_views


urlpatterns = [
    path('admin/', admin.site.urls),
    path('user_management/', include('user_management.urls', namespace='user_management')),
    path('api/', include('api.urls', namespace='api')),
    path('', include('flights.urls', namespace='flights')),
    path('booking/', include('booking.urls', namespace='booking')),
    #path('tf_auth/', include(tf_urls))
]

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\bilety_ru\wsgi.py
=============================
"""
WSGI config for bilety_ru project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bilety_ru.settings')

application = get_wsgi_application()

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\bilety_ru\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\migrations\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\static\booking\css\base.css
=============================
/* Основные стили для проекта bilety_ru */

/* Стили для карточек рейсов */

:root {
    --primary-color: #4a90e2;
    --secondary-color: #f5f7fa;
    --accent-color: #ff6b6b;
    --text-color: #333;
    --light-text: #777;
    --border-radius: 8px;
    --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

body {
    font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
    color: var(--text-color);
    background-color: #f8f9fa;
    line-height: 1.6;
}

.navbar {
    background-color: white;
    box-shadow: var(--box-shadow);
}

.navbar-brand {
    font-weight: 700;
    color: var(--primary-color) !important;
    font-size: 1.5rem;
}

.nav-link {
    color: var(--text-color) !important;
    font-weight: 500;
    transition: color 0.2s;
}

.nav-link:hover {
    color: var(--primary-color) !important;
}

.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    border-radius: var(--border-radius);
    font-weight: 500;
    padding: 0.5rem 1.5rem;
    transition: all 0.2s;
}

.btn-primary:hover {
    background-color: #3a80d2;
    border-color: #3a80d2;
    transform: translateY(-2px);
}

.btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
    border-radius: var(--border-radius);
    font-weight: 500;
    padding: 0.5rem 1.5rem;
    transition: all 0.2s;
}

.btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.container {
    padding: 2rem 1rem;
}

/* Стили для аватара пользователя */

.avatar-dropdown {
    cursor: pointer;
    position: relative;
}

.avatar-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-color);
}

.dropdown-menu {
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    border: none;
    margin-top: 0.5rem;
}

.dropdown-item {
    padding: 0.5rem 1.5rem;
    color: var(--text-color);
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: var(--secondary-color);
    color: var(--primary-color);
}


=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\static\booking\css\booking.css
=============================
/* Стили для страницы бронирования */

.booking-container {
    max-width: 900px;
    margin: 0 auto;
}
.booking-form {
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}
.form-section:last-child {
    border-bottom: none;
}
.section-title {
    margin-bottom: 20px;
    color: #007bff;
}

.booking-container {
    max-width: 900px;
    margin: 0 auto;
}
.flight-details {
    background-color: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.flight-segment {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px dashed #eee;
}
.flight-segment:last-child {
    border-bottom: none;
}
.airline-logo {
    height: 30px;
    margin-right: 10px;
}
.flight-arrow {
    color: #007bff;
    font-size: 20px;
    margin: 0 10px;
}
.flight-price {
    font-size: 24px;
    font-weight: bold;
    color: #28a745;
}
.booking-form {
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}
.form-section:last-child {
    border-bottom: none;
}
.section-title {
    margin-bottom: 20px;
    color: #007bff;
}
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    display: none;
}
.loading-spinner {
    text-align: center;
}
.payment-options {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
}
.payment-option {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    width: 120px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}
.payment-option:hover {
    border-color: #007bff;
    background-color: #f0f7ff;
}
.payment-option.selected {
    border-color: #007bff;
    background-color: #e6f2ff;
}
.payment-option img {
    height: 40px;
    margin-bottom: 10px;
}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\static\booking\js\booking.js
=============================
/**
 * booking.js - Скрипт для страницы бронирования билетов
 * Обрабатывает динамическое обновление цен и взаимодействие с формой бронирования
 */
let adults_count = document.getElementById('adults_count').value;
let childs_count = document.getElementById('children_count').value;
let infants_count = document.getElementById('infants_count').value;
const arr_n = [adults_count, childs_count, infants_count];
const types = ['adult', 'child', 'infant'];


for (let i = 0; i < 3; i++)
{
    console.log(arr_n[i])
    for (let j = 0; j < arr_n[i]; j++)
    {
        //console.log(j)
        let index = j + 1;
        console.log(`${types[i]}_${j}_document_type`)
        document.getElementById(`${types[i]}_${index}_document_type`).addEventListener('change', function() {
            showDynamicFields(this.value, i, index);
        });
    }
}

function showDynamicFields(selectedValue, i, j) {
    const dynamicFields = document.getElementById(`${types[i]}_${j}_document_data`);
    console.log(`${types[i]}_${j}_document_data`);
    // Очищаем предыдущие поля
    dynamicFields.innerHTML = '';
    
    // В зависимости от выбранного значения показываем соответствующие поля
    switch(selectedValue) {
        case 'PASSPORT':
            dynamicFields.innerHTML = `
                <label for="${types[i]}_${j}_document_number">Номер документа</label>
                <input type="text" class="form-control" id="${types[i]}_${j}_document_number" name="${types[i]}_${j}_document_number" required>
            `;
            break;
        
        case 'ID_CARD':
            dynamicFields.innerHTML = `
            <div class="col-md-4 form-group">
                <label for="${types[i]}_${j}_document_series">Серия</label>
                <input type="text" class="form-control" id="${types[i]}_${j}_document_series" name="${types[i]}_${j}_document_series" required style="width:10em;">
            </div>
            <div class="col-md-4 form-group">
                <label for="${types[i]}_${j}_two_letters">2 буквы</label>
                <input type="text" class="form-control" id="${types[i]}_${j}_two_letters" name="${types[i]}_${j}_two_letters" required>
            </div>
            <div class="col-md-4 form-group">
                <label for="child_{{ i }}_document_number">Номер документа</label>
                <input type="text" class="form-control" id="${types[i]}_${j}_document_number" name="${types[i]}_${j}_document_number" required style="width:10em;">
            </div>
            `;
            break;
        default:
            dynamicFields.innerHTML = ``
            break;
    }
}


document.addEventListener('DOMContentLoaded', function() {
    // Получаем ID предложения из URL
    const urlParts = window.location.pathname.split('/');
    const offerId = urlParts[urlParts.indexOf('booking') + 1];
    for (let i = 0; i < 3; i++)
    {
        for (let j = 0; j < arr_n[i]; j++)
        {
            let index = j + 1;
            const initalSelect = document.getElementById(`${types[i]}_${index}_document_type`)
            console.log(`${types[i]}_${index}_document_type`)
            showDynamicFields(initalSelect.value, i, index)
        }
    }
    
    // Элементы для обновления цены
    const totalPriceElement = document.getElementById('totalPrice');
    const originalPriceElement = document.getElementById('originalPrice');
    const priceDifferenceElement = document.getElementById('priceDifference');
    const priceAlertElement = document.getElementById('priceAlert');
    
    // Интервал проверки цены (каждые 60 секунд)
    const priceCheckInterval = 60000; // Увеличиваем до 60 секунд
    let priceCheckTimer;
    

    // Новая версия функции проверки актуальности цены
    function checkCurrentPrice(offerId) {
        fetch(`/api/check-price/${offerId}/`)
            .then(response => response.json())
            .then(data => {
                
                if (!data.success) {
                    // Обработка ошибки (например, показать alert)
                    console.log(data.error || 'Ошибка при проверке цены');
                    return;
                }
                // Получаем текущую цену из DOM
                const totalPriceElement = document.getElementById('totalPrice');
                const currentPriceText = totalPriceElement.textContent;
                const currentPrice = parseFloat(currentPriceText.replace(/[^0-9.]/g, ''));
                // Получаем новую цену из ответа API
                const newPrice = parseFloat(data.price);
                const currency = data.currency;
                //console.log(currentPriceText, currentPrice, newPrice, currency);

                if (newPrice !== currentPrice) {
                    // Обновляем цену на странице
                    totalPriceElement.textContent = `${newPrice} ${currency}`;
                    // Можно добавить уведомление о смене цены
                    alert(`Цена изменилась! Новая цена: ${newPrice} ${currency}`);
                }
            })
            .catch(error => {
                console.error('Ошибка при проверке цены:', error);
            });
    }

    // Загружаем информацию о рейсе при загрузке страницы
    console.log(1);
    //loadFlightDetails();
    console.log(2);
    // Запускаем первую проверку цены с задержкой в 3 секунды,
    // чтобы сначала загрузилась информация о рейсе
    setTimeout(checkCurrentPrice(offerId), 3000);

    // Устанавливаем интервал для периодической проверки
    priceCheckTimer = setInterval(checkCurrentPrice, priceCheckInterval);
    
    // Валидация формы перед отправкой
    /*
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        // Проверяем заполнение всех обязательных полей
        const requiredFields = document.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        // Проверяем валидность email
        const emailField = document.getElementById('contactEmail');
        if (emailField && emailField.value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailField.value)) {
                isValid = false;
                emailField.classList.add('is-invalid');
                document.getElementById('emailFeedback').textContent = 'Пожалуйста, введите корректный email';
            }
        }
        
        // Проверяем валидность телефона
        const phoneField = document.getElementById('contactPhone');
        if (phoneField && phoneField.value) {
            const phoneRegex = /^[+]?[\d\s()-]{10,20}$/;
            if (!phoneRegex.test(phoneField.value)) {
                isValid = false;
                phoneField.classList.add('is-invalid');
                document.getElementById('phoneFeedback').textContent = 'Пожалуйста, введите корректный номер телефона';
            }
        }
        
        // Если форма не валидна, предотвращаем отправку
        if (!isValid) {
            e.preventDefault();
            // Прокручиваем к первому невалидному полю
            const firstInvalid = document.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
        } else {
            // Показываем загрузчик при отправке формы
            document.getElementById('loadingOverlay').style.display = 'flex';
        }*/
    
    // Очищаем интервал при уходе со страницы
    window.addEventListener('beforeunload', function() {
        clearInterval(priceCheckTimer);
    });
    /*
    // Обработчики для полей формы (удаление класса is-invalid при вводе)
    document.querySelectorAll('input, select').forEach(element => {
        element.addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });
    });
    */
    // Обработчик для кнопки "Продолжить с новой ценой"
    /*
    document.getElementById('acceptNewPrice').addEventListener('click', function() {
        priceAlertElement.classList.add('d-none');
    });*/
});

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\templates\booking\base.html
=============================
<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Билеты.ру - Поиск и бронирование авиабилетов{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <!-- Font Awesome для иконок -->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">-->
    <!-- Пользовательские стили -->
    <link rel="stylesheet" href="{% static 'flights/css/base.css' %}">
    <style>
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>

    <!-- Навигационная панель -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="{% url 'flights:home' %}">
                <i class="fas fa-plane-departure mr-2"></i>Билеты.ру
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <!--<ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'flights:home' %}">Главная</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Спецпредложения</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Помощь</a>
                    </li>
                </ul>-->
                
                <div class="ml-auto">
                    {% if user.is_authenticated %}
                        <!-- Аватар с выпадающим меню для авторизованных пользователей -->
                        <div class="dropdown avatar-dropdown">
                            <div class="d-flex align-items-center" id="userDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <!-- <img src="{% static 'flights/img/default-avatar.png' %}" alt="Аватар" class="avatar-img" onerror="this.src='https://via.placeholder.com/40?text={{ user.username|first|upper }}'"> -->
                                <span class="ml-2 d-none d-md-inline">{{ user.username }}</span>
                                <!-- <i class="fas fa-chevron-down ml-2 small"></i> -->
                            </div>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="{% url 'user_management:profile' %}">
                                    <i class="fas fa-user mr-2"></i>Профиль
                                </a>
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-history mr-2"></i>История бронирований
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="{% url 'user_management:logout' %}">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Выйти
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <!-- Кнопки для неавторизованных пользователей -->
                        <a href="{% url 'user_management:signin' %}" class="btn btn-outline-primary mr-2">
                            <i class="fas fa-sign-in-alt mr-1"></i>Войти
                        </a>
                        <a href="{% url 'user_management:signup' %}" class="btn btn-primary">
                            <i class="fas fa-user-plus mr-1"></i>Регистрация
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <main class="container">
        {% if messages %}
            <div class="messages mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\templates\booking\booking.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Оформление билета - Билеты.ру{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'booking/css/booking.css' %}">
{% endblock %}

{% block content %}
<div class="booking-container">
    <h2 class="mb-4">Оформление билета</h2>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Загрузка...</span>
            </div>
            <p class="mt-2">Проверяем актуальность цены...</p>
        </div>
    </div>
    
    <div class="flight-details" id="flightDetails">
         <div class="row">
            <div class="col-md-8">
                <h4>Детали рейса</h4>
                <div class="flight-route">
                    <span class="h5">{{ dep_airport }} ({{ dep_iataCode }})</span>
                    <span class="flight-arrow">→</span>
                    <span class="h5">{{ arr_airport }} ({{ arr_iataCode }})</span>
                </div>
                <div class="flight-duration">
                    <small>Общее время в пути: {{ offer.duration|time:"H:i" }}</small>
                </div>
            </div>
            <div class="col-md-4 text-right">
                <div class="price-info">
                    <div class="price-alert alert alert-info d-none" id="priceAlert">
                        <p>Цена изменилась!</p>
                        <p>Старая цена: <span id="originalPrice"></span></p>
                        <p>Разница: <span id="priceDifference"></span></p>
                        <button type="button" class="btn btn-sm btn-primary" id="acceptNewPrice">Продолжить с новой ценой</button>
                    </div>
                    <div class="flight-price">
                        <span id="totalPrice">{{ offer.totalPrice }} {{ offer.currencyCode }}</span>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="segments-container">
            {% for s in segments %}
            <div class="flight-segment">
                <div class="row">
                    <div class="col-md-1">
                        <div class="airline-logo">
                            <img src="https://pics.avs.io/80/40/{{ s.carrierCode }}.png" alt="{{ segment.carrierCode }}" class="img-fluid">
                        </div>
                    </div>
                    <div class="col-md-11">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="departure-info">
                                    <div class="time">{{ s.dep_dateTime }}</div>
                                    <div class="airport">{{ s.dep_airport }} ({{ s.dep_iataCode }})</div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="flight-duration">
                                    <div class="duration">{{ s.duration }}</div>
                                    <div class="flight-line">&#8212;&#8212;&#8212;&#9992;&#8212;&#8212;&#8212;</div>
                                    <div class="flight-number">{{ s.carrierCode }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="arrival-info">
                                    <div class="time">{{ s.arr_dateTime }}</div>
                                    <div class="airport">{{ s.arr_airport }} ({{ s.arr_iataCode }})</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {{ return_segements }}
            {% if return_segments %}
            <p>Маршрут обратно:</p>
            {% for s in return_segments %}
            <div class="flight-segment">
                <div class="row">
                    <div class="col-md-1">
                        <div class="airline-logo">
                            <img src="https://pics.avs.io/80/40/{{ s.carrierCode }}.png" alt="{{ segment.carrierCode }}" class="img-fluid">
                        </div>
                    </div>
                    <div class="col-md-11">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="departure-info">
                                    <div class="time">{{ s.dep_dateTime }}</div>
                                    <div class="airport">{{ s.dep_airport }} ({{ s.dep_iataCode }})</div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="flight-duration">
                                    <div class="duration">{{ s.duration }}</div>
                                    <div class="flight-line">&#8212;&#8212;&#8212;&#9992;&#8212;&#8212;&#8212;</div>
                                    <div class="flight-number">{{ s.carrierCode }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="arrival-info">
                                    <div class="time">{{ s.arr_dateTime }}</div>
                                    <div class="airport">{{ s.arr_airport }} ({{ s.arr_iataCode }})</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        <!--<div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Загрузка...</span>
            </div>
        </div>-->
    </div>
    
    <form method="post" action="{% url 'booking:booking_index' offer.id %}" id="bookingForm">
        {% csrf_token %}
        <input type="hidden" name="actualPrice" id="actualPrice" value="{{ offer.total_price }}">
        
        <div class="form-section">
            <h4 class="section-title">Информация о пассажирах</h4>
            
            <!-- Скрытые поля для хранения количества пассажиров -->
            <input type="hidden" id="adults_count" name="adults_count" value="{{ adults }}">
            <input type="hidden" id="children_count" name="children_count" value="{{ children }}">
            <input type="hidden" id="infants_count" name="infants_count" value="{{ infants }}">
            
            <div id="passengersContainer">
                <!-- Формы для взрослых пассажиров -->
                {% if adults > 0 %}
                <div class="passenger-type-header">
                    <h5>Взрослые пассажиры (от 12 лет)</h5>
                </div>
                {% for i in adults_range %}
                <div class="passenger-info card mb-3">
                    <div class="card-header">
                        Взрослый пассажир {{ i }}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="adult_{{ i }}_first_name">Имя</label>
                                <input type="text" class="form-control" id="adult_{{ i }}_first_name" name="adult_{{ i }}_first_name" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="adult_{{ i }}_last_name">Фамилия</label>
                                <input type="text" class="form-control" id="adult_{{ i }}_last_name" name="adult_{{ i }}_last_name" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="adult_{{ i }}_surname">Отчество</label>
                                <input type="text" class="form-control" id="adult_{{ i }}_surname" name="adult_{{ i }}_surname" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="adult_{{ i }}_dob">Дата рождения</label>
                                <input type="date" class="form-control" id="adult_{{ i }}_dob" name="adult_{{ i }}_dob" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="adult_{{ i }}_gender">Пол</label>
                                <select class="form-control" id="adult_{{ i }}_gender" name="adult_{{ i }}_gender" required>
                                    <option value="">Выберите</option>
                                    <option value="MALE">Мужской</option>
                                    <option value="FEMALE">Женский</option>
                                </select>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="adult_{{ i }}_document_type">Тип документа</label>
                                <select class="form-control" id="adult_{{ i }}_document_type" name="adult_{{ i }}_document_type" required>
                                    <option value="">Выберите</option>
                                    <option value="PASSPORT">Паспорт</option>
                                    <option value="ID_CARD">Свидетельство о рождения</option>
                                </select>
                            </div>
                            <script>
                                document.getElementById('adult_{{ i }}_document_type').value = 'PASSPORT';
                            </script>
                            <div id="adult_{{ i }}_document_data"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
                
                <!-- Формы для детей -->
                {% if children > 0 %}
                <div class="passenger-type-header">
                    <h5>Дети (от 2 до 12 лет)</h5>
                </div>
                {% for i in children_range %}
                <div class="passenger-info card mb-3">
                    <div class="card-header">
                        Ребенок {{ i }}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="child_{{ i }}_first_name">Имя</label>
                                <input type="text" class="form-control" id="child_{{ i }}_first_name" name="child_{{ i }}_first_name" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="child_{{ i }}_last_name">Фамилия</label>
                                <input type="text" class="form-control" id="child_{{ i }}_last_name" name="child_{{ i }}_last_name" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="child_{{ i }}_surname">Отчество</label>
                                <input type="text" class="form-control" id="child_{{ i }}_surname" name="child_{{ i }}_surname" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="child_{{ i }}_dob">Дата рождения</label>
                                <input type="date" class="form-control" id="child_{{ i }}_dob" name="child_{{ i }}_dob" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="child_{{ i }}_gender">Пол</label>
                                <select class="form-control" id="child_{{ i }}_gender" name="child_{{ i }}_gender" required>
                                    <option value="">Выберите</option>
                                    <option value="MALE">Мужской</option>
                                    <option value="FEMALE">Женский</option>
                                </select>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="child_{{ i }}_document_type">Тип документа</label>
                                <select class="form-control" id="child_{{ i }}_document_type" name="child_{{ i }}_document_type" required>
                                    <option value="">Выберите</option>
                                    <option value="ID_CARD">Свидетельство о рождения</option>
                                </select>
                            </div>
                            <script>
                                document.getElementById('child_{{ i }}_document_type').value = 'ID_CARD';
                            </script>
                            <div id="child_{{ i }}_document_data"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
                
                <!-- Формы для младенцев -->
                {% if infants > 0 %}
                <div class="passenger-type-header">
                    <h5>Младенцы (до 2 лет)</h5>
                </div>
                {% for i in infants_range %}
                <div class="passenger-info card mb-3">
                    <div class="card-header">
                        Младенец {{ i }}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="infant_{{ i }}_first_name">Имя</label>
                                <input type="text" class="form-control" id="infant_{{ i }}_first_name" name="infant_{{ i }}_first_name" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="infant_{{ i }}_last_name">Фамилия</label>
                                <input type="text" class="form-control" id="infant_{{ i }}_last_name" name="infant_{{ i }}_last_name" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="infant_{{ i }}_surname">Отчество</label>
                                <input type="text" class="form-control" id="infant_{{ i }}_surname" name="infant_{{ i }}_surname" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="infant_{{ i }}_dob">Дата рождения</label>
                                <input type="date" class="form-control" id="infant_{{ i }}_dob" name="infant_{{ i }}_dob" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="infant_{{ i }}_gender">Пол</label>
                                <select class="form-control" id="infant_{{ i }}_gender" name="infant_{{ i }}_gender" required>
                                    <option value="">Выберите</option>
                                    <option value="MALE">Мужской</option>
                                    <option value="FEMALE">Женский</option>
                                </select>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="infant_{{ i }}_document_type">Тип документа</label>
                                <select class="form-control" id="infant_{{ i }}_document_type" name="infant_{{ i }}_document_type" required>
                                    <option value="">Выберите</option>
                                    <option value="ID_CARD">Свидетельство о рождения</option>
                                </select>
                            </div>
                            <script>
                                document.getElementById('infant_{{ i }}_document_type').value = 'ID_CARD';
                            </script>
                            <div id="infant_{{ i }}_document_data"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        <div class="form-section">
            <h4 class="section-title">Контактная информация</h4>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="contact_email">Email</label>
                    <input type="email" class="form-control" id="contact_email" name="contact_email" required>
                </div>
                <!--<div class="col-md-6 form-group">
                    <label for="contact_phone">Телефон</label>
                    <input type="tel" class="form-control" id="contact_phone" name="contact_phone" required>
                </div>-->
            </div>
        </div>
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">Оформить билет</button>
        </div>
    </form>
</div>
<script src="{% static 'booking/js/booking.js' %}"></script>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\templates\booking\booking_data.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Данные бронирования - Билеты.ру{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'booking/css/booking.css' %}">
<style>
    .booking-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .success-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 30px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .success-icon {
        font-size: 80px;
        color: #28a745;
        margin-bottom: 20px;
    }
    .order-details {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 30px;
    }
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .detail-label {
        font-weight: bold;
        color: #6c757d;
    }
    .detail-value {
        text-align: right;
    }
    .print-button {
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        margin-right: 10px;
        font-weight: bold;
        transition: background-color 0.3s;
    }
    .print-button:hover {
        background-color: #5a6268;
    }
    .home-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-weight: bold;
        transition: background-color 0.3s;
    }
    .home-button:hover {
        background-color: #0056b3;
    }
</style>
{% endblock %}

{% block content %}

<div class="success-container-wrapper">
    <div class="success-container text-center">
        <div class="order-details">
            <h4 class="mb-3">Номер бронирования: {{ booking.id }}</h4>
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% else %}
                <div class="detail-row">
                    <div class="detail-label">Дата вылета:</div>
                    <div class="detail-value">{{ segments.0.dep_dateTime|date:"d.m.Y H:i" }}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Количество пассажиров:</div>
                    <div class="detail-value">{{ passengers|length }}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Итоговая стоимость:</div>
                    <div class="detail-value">{{ booking.total_price }} {{ booking.currency_code }}</div>
                </div>
                <h4 class="mt-4 mb-3">Детали рейса</h4>
                <div class="flight-route">
                    <span class="h5">{{ dep_airport }} ({{ dep_iataCode }})</span>
                    <span class="flight-arrow">→</span>
                    <span class="h5">{{ arr_airport }} ({{ arr_iataCode }})</span>
                </div>
                <div class="flight-duration">
                    <small>Общее время в пути: {{ offer.duration|time:"H:i" }}</small>
                </div>
                <div class="flight-details" id="flightDetails">
                    <hr>
                    <div class="segments-container">
                        {% for s in segments %}
                        <div class="flight-segment">
                            <div class="row">
                                <div class="col-md-1">
                                    <div class="airline-logo">
                                        <img src="https://pics.avs.io/80/40/{{ s.carrierCode }}.png" alt="{{ segment.carrierCode }}" class="img-fluid">
                                    </div>
                                </div>
                                <div class="col-md-11">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="departure-info">
                                                <div class="time">{{ s.dep_dateTime }}</div>
                                                <div class="airport">{{ s.dep_airport }} ({{ s.dep_iataCode }})</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="flight-duration">
                                                <div class="duration">{{ s.duration }}</div>
                                                <div class="flight-line">&#8212;&#8212;&#8212;&#9992;&#8212;&#8212;&#8212;</div>
                                                <div class="flight-number">{{ s.carrierCode }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="arrival-info">
                                                <div class="time">{{ s.arr_dateTime }}</div>
                                                <div class="airport">{{ s.arr_airport }} ({{ s.arr_iataCode }})</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {{ return_segements }}
                        {% if return_segments %}
                        <p>Маршрут обратно:</p>
                        {% for s in return_segments %}
                        <div class="flight-segment">
                            <div class="row">
                                <div class="col-md-1">
                                    <div class="airline-logo">
                                        <img src="https://pics.avs.io/80/40/{{ s.carrierCode }}.png" alt="{{ segment.carrierCode }}" class="img-fluid">
                                    </div>
                                </div>
                                <div class="col-md-11">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="departure-info">
                                                <div class="time">{{ s.dep_dateTime }}</div>
                                                <div class="airport">{{ s.dep_airport }} ({{ s.dep_iataCode }})</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="flight-duration">
                                                <div class="duration">{{ s.duration }}</div>
                                                <div class="flight-line">&#8212;&#8212;&#8212;&#9992;&#8212;&#8212;&#8212;</div>
                                                <div class="flight-number">{{ s.carrierCode }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="arrival-info">
                                                <div class="time">{{ s.arr_dateTime }}</div>
                                                <div class="airport">{{ s.arr_airport }} ({{ s.arr_iataCode }})</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                </div>
                <h5 class="mt-4 mb-3">Информация о пассажирах</h5>
                {% for passenger in passengers %}
                <div class="card mb-3">
                    <div class="card-header">
                        Пассажир {{ forloop.counter }} - {% if passenger.type == 'ADULT'%} Взрослый {% elif passenger.type == 'CHILD' %} Ребенок {% elif passenger.type == 'INFANT' %} Младенец {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Имя:</strong> {{ passenger.firstName }}</p>
                                <p><strong>Фамилия:</strong> {{ passenger.lastName }}</p>
                                <p><strong>Отчество:</strong> {{ passenger.surname}}</p>
                                <p><strong>Пол:</strong> {% if passenger.gender == 'MALE' %} Мужской {% elif passenger.gender == 'FEMALE' %} Женский {% else %} Не указан {% endif %}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Дата рождения:</strong> {{ passenger.dateOfBirth }}</p>
                                <p><strong>Документ:</strong> {{ passenger.documentType }}</p>
                                {% if passenger.documentType == 'PASSPORT' %}
                                <p><strong>Номер:</strong> {{ passenger.documentNumber }}</p>
                                {% else %}
                                <p><strong>Серия:</strong> {{ passenger.documentSeries }}</p>
                                <p><strong>2 Буквы:</strong> {{ passenger.twoLetters }}</p>
                                <p><strong>Номер:</strong> {{ passenger.documentNumber }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <div class="mt-4">
            <a href="{% url 'user_management:profile' %}" class="home-button">Назад</a>
            <a href="/" class="home-button">На главную</a>
        </div>
    </div>
</div>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\templates\booking\booking_success.html
=============================
{% extends 'flights/base.html' %}
{% load static %}
{% load tz %}
{% load l10n %}

{% block title %}Заказ оформлен - Билеты.ру{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'booking/css/booking.css' %}">
<style>
    .booking-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .success-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 30px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .success-icon {
        font-size: 80px;
        color: #28a745;
        margin-bottom: 20px;
    }
    .order-details {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 30px;
    }
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .detail-label {
        font-weight: bold;
        color: #6c757d;
    }
    .detail-value {
        text-align: right;
    }
    .print-button {
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        margin-right: 10px;
        font-weight: bold;
        transition: background-color 0.3s;
    }
    .print-button:hover {
        background-color: #5a6268;
    }
    .home-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-weight: bold;
        transition: background-color 0.3s;
    }
    .home-button:hover {
        background-color: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="success-container-wrapper">
    <div class="success-container text-center">
        <div class="success-icon">✓</div>
        <h2 class="mb-4">Заказ успешно оформлен!</h2>
        <p class="lead">Ваш билет успешно забронирован. Подтверждение отправлено на указанный email.</p>
        
        <div class="order-details">
            <h4 class="mb-3">Детали заказа</h4>
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% else %}
                <div class="detail-row">
                    <div class="detail-label">Номер бронирования:</div>
                    <div class="detail-value">{{ booking.id }}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Дата вылета:</div>
                    <div class="detail-value">{{ segments.0.dep_dateTime|date:"d.m.Y H:i" }}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Количество пассажиров:</div>
                    <div class="detail-value">{{ passengers|length }}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Итоговая стоимость:</div>
                    <div class="detail-value">{{ booking.total_price }} {{ booking.currency_code }}</div>
                </div>
                <h4 class="mt-4 mb-3">Детали рейса</h4>
                <div class="flight-route">
                    <span class="h5">{{ dep_airport }} ({{ dep_iataCode }})</span>
                    <span class="flight-arrow">→</span>
                    <span class="h5">{{ arr_airport }} ({{ arr_iataCode }})</span>
                </div>
                <div class="flight-duration">
                    <small>Общее время в пути: {{ offer.duration|time:"H:i" }}</small>
                </div>
                <div class="flight-details" id="flightDetails">
                    <hr>
                    <div class="segments-container">
                        {% for s in segments %}
                        <div class="flight-segment">
                            <div class="row">
                                <div class="col-md-1">
                                    <div class="airline-logo">
                                        <img src="https://pics.avs.io/80/40/{{ s.carrierCode }}.png" alt="{{ segment.carrierCode }}" class="img-fluid">
                                    </div>
                                </div>
                                <div class="col-md-11">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="departure-info">
                                                <div class="time">{{ s.dep_dateTime }}</div>
                                                <div class="airport">{{ s.dep_airport }} ({{ s.dep_iataCode }})</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="flight-duration">
                                                <div class="duration">{{ s.duration }}</div>
                                                <div class="flight-line">&#8212;&#8212;&#8212;&#9992;&#8212;&#8212;&#8212;</div>
                                                <div class="flight-number">{{ s.carrierCode }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="arrival-info">
                                                <div class="time">{{ s.arr_dateTime }}</div>
                                                <div class="airport">{{ s.arr_airport }} ({{ s.arr_iataCode }})</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {{ return_segements }}
                        {% if return_segments %}
                        <p>Маршрут обратно:</p>
                        {% for s in return_segments %}
                        <div class="flight-segment">
                            <div class="row">
                                <div class="col-md-1">
                                    <div class="airline-logo">
                                        <img src="https://pics.avs.io/80/40/{{ s.carrierCode }}.png" alt="{{ segment.carrierCode }}" class="img-fluid">
                                    </div>
                                </div>
                                <div class="col-md-11">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="departure-info">
                                                <div class="time">{{ s.dep_dateTime }}</div>
                                                <div class="airport">{{ s.dep_airport }} ({{ s.dep_iataCode }})</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="flight-duration">
                                                <div class="duration">{{ s.duration }}</div>
                                                <div class="flight-line">&#8212;&#8212;&#8212;&#9992;&#8212;&#8212;&#8212;</div>
                                                <div class="flight-number">{{ s.carrierCode }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="arrival-info">
                                                <div class="time">{{ s.arr_dateTime }}</div>
                                                <div class="airport">{{ s.arr_airport }} ({{ s.arr_iataCode }})</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    <!--<div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Загрузка...</span>
                        </div>
                    </div>-->
                </div>
                <!-- Информация о пассажирах -->
                <h5 class="mt-4 mb-3">Информация о пассажирах</h5>
                {% for passenger in passengers %}
                <div class="card mb-3">
                    <div class="card-header">
                        Пассажир {{ forloop.counter }} - {% if passenger.type == 'ADULT'%} Взрослый {% elif passenger.type == 'CHILD' %} Ребенок {% elif passenger.type == 'INFANT' %} Младенец {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Имя:</strong> {{ passenger.firstName }}</p>
                                <p><strong>Фамилия:</strong> {{ passenger.lastName }}</p>
                                <p><strong>Отчество:</strong> {{ passenger.surname}}</p>
                                <p><strong>Пол:</strong> {% if passenger.gender == 'MALE' %} Мужской {% elif passenger.gender == 'FEMALE' %} Женский {% else %} Не указан {% endif %}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Дата рождения:</strong> {{ passenger.dateOfBirth }}</p>
                                <p><strong>Документ:</strong> {{ passenger.documentType }}</p>
                                {% if passenger.documentType == 'PASSPORT' %}
                                <p><strong>Номер:</strong> {{ passenger.documentNumber }}</p>
                                {% else %}
                                <p><strong>Серия:</strong> {{ passenger.documentSeries }}</p>
                                <p><strong>2 Буквы:</strong> {{ passenger.twoLetters }}</p>
                                <p><strong>Номер:</strong> {{ passenger.documentNumber }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Контактная информация -->
                <h5 class="mt-4 mb-3">Контактная информация</h5>
                <div class="detail-row">
                    <div class="detail-label">Email:</div>
                    <div class="detail-value">{{ booking.contact_email }}</div>
                </div>
                <!--<div class="detail-row">
                    <div class="detail-label">Телефон:</div>
                    <div class="detail-value">{{ booking.contact_phone }}</div>
                </div>-->
            {% endif %}
        </div>
        
        <div class="mt-4">
            <!--<button class="print-button" onclick="window.print();">Распечатать</button>-->
            <a href="/" class="home-button">На главную</a>
        </div>
    </div>
</div>

<!--<script>
    document.addEventListener('DOMContentLoaded', function() {
        const orderId = document.getElementById('orderId').textContent;
        
        // Получаем информацию о заказе
        fetch(`/api/order/${orderId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                // Заполняем детали заказа
                document.getElementById('route').textContent = `${data.origin} → ${data.destination}`;
                document.getElementById('departureDate').textContent = data.departureDate;
                document.getElementById('passengerCount').textContent = data.passengerCount;
                document.getElementById('totalPrice').textContent = `${data.totalPrice} ${data.currencyCode}`;
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });
</script>-->
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\admin.py
=============================
from django.contrib import admin

# Register your models here.

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\apps.py
=============================
from django.apps import AppConfig


class BookingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'booking'

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\email_sender.py
=============================
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.utils import formatdate
import os
from datetime import datetime
from typing import List, Dict, Optional

class FlightBookingEmailSender:
    def __init__(self):
        # Настройки SMTP для разных почтовых сервисов
        self.smtp_settings = {
            'gmail': {
                'server': 'smtp.gmail.com',
                'port': 587
            },
            'mail_ru': {
                'server': 'smtp.mail.ru',
                'port': 587
            },
            'yandex': {
                'server': 'smtp.yandex.ru',
                'port': 587
            }
        }
    
    def _get_smtp_config(self, email: str) -> Dict:
        """Определяем SMTP сервер по домену email"""
        if 'gmail.com' in email:
            return self.smtp_settings['gmail']
        elif 'mail.ru' in email or 'bk.ru' in email or 'inbox.ru' in email:
            return self.smtp_settings['mail_ru']
        elif 'yandex.ru' in email or 'yandex.com' in email:
            return self.smtp_settings['yandex']
        else:
            # По умолчанию используем Gmail
            return self.smtp_settings['gmail']
    
    def _create_booking_html_template(self, booking_data: Dict) -> str: 
        # Генерация HTML для каждого пассажира
        passengers_html = ""
        for i, passenger in enumerate(booking_data['passenger_data']['passengers'], 1):
            passengers_html += f"""
            <div class="passenger-card">
                <h4>👤 Пассажир {i}</h4>
                <table>
                    <tr>
                        <th>ФИО</th>
                        <td>{passenger['firstName']} {passenger['lastName']} {passenger['surname']}</td>
                    </tr>
                    <tr>
                        <th>Тип пассажира</th>
                        <td>{passenger['type']}</td>
                    </tr>
                </table>
            </div>
            """
        
        # Генерация информации о стоимости
        #total_price = sum(float(passenger['price'].replace(' ', '')) for passenger in booking_data['passengers'])
        html_template = f"""
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Подтверждение бронирования авиабилетов</title>
        <style>
            body {{
                font-family: 'Arial', sans-serif;
                line-height: 1.6;
                color: #333;
                max-width: 700px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f4f4f4;
            }}
            .container {{
                background: white;
                border-radius: 10px;
                padding: 30px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }}
            .header {{
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                padding: 20px;
                border-radius: 10px 10px 0 0;
                text-align: center;
                margin: -30px -30px 20px -30px;
            }}
            .booking-number {{
                background: #ffc107;
                color: #333;
                padding: 10px 20px;
                border-radius: 5px;
                font-weight: bold;
                display: inline-block;
                margin: 10px 0;
            }}
            .flight-info {{
                background: #f8f9fa;
                border-left: 4px solid #007bff;
                padding: 15px;
                margin: 20px 0;
                border-radius: 0 5px 5px 0;
            }}
            .passengers-section {{
                margin: 25px 0;
            }}
            .passenger-card {{
                background: #e8f5e8;
                border: 1px solid #28a745;
                padding: 15px;
                border-radius: 5px;
                margin: 10px 0;
            }}
            .passenger-card h4 {{
                margin-top: 0;
                color: #155724;
            }}
            .price-summary {{
                background: #fff3cd;
                border: 2px solid #ffc107;
                padding: 20px;
                border-radius: 5px;
                margin: 20px 0;
            }}
            .price-breakdown {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                margin: 15px 0;
            }}
            .qr-code {{
                text-align: center;
                margin: 20px 0;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 5px;
            }}
            .footer {{
                text-align: center;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #ddd;
                color: #666;
                font-size: 12px;
            }}
            .important {{
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                padding: 15px;
                border-radius: 5px;
                margin: 15px 0;
            }}
            table {{
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }}
            th, td {{
                padding: 8px 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }}
            th {{
                background: rgba(0,0,0,0.05);
                font-weight: 600;
            }}
            .total-price {{
                font-size: 1.3em;
                font-weight: bold;
                color: #d63384;
                text-align: center;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 5px;
            }}
            .segment-divider {{
                border-left: 3px dashed #007bff;
                height: 40px;
                margin: 10px 0 10px 20px;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>✈️ Подтверждение бронирования</h1>
                <div class="booking-number">Номер бронирования: {booking_data['order_id']}</div>
                <p>Количество пассажиров: {len(booking_data['passenger_data']['passengers'])}</p>
            </div>
            
            <!-- Информация о рейсе -->
            <div class="flight-info">
                <h3>📅 Информация о рейсе</h3>
                <table>
                    <tr>
                        <th>Маршрут</th>
                        <td>{booking_data['departure_city']} → {booking_data['arrival_city']}</td>
                    </tr>
                    <tr>
                        <th>Авиакомпания</th>
                        <td>{booking_data['airline']}</td>
                    </tr>
                    <tr>
                        <th>Номер самолёта</th>
                        <td>{booking_data['flight_number']}</td>
                    </tr>
                    <tr>
                        <th>Терминал</th>
                        <td>{booking_data['terminal']}</td>
                    </tr>
                    <tr>
                        <th>Дата вылета</th>
                        <td>{booking_data['departure_date'].strftime('%Y-%m-%d')} в {booking_data['departure_date'].strftime('%H:%m')}</td>
                    </tr>
                    <tr>
                        <th>Дата прибытия</th>
                        <td>{booking_data['arrival_date'].strftime('%Y-%m-%d')} в {booking_data['arrival_date'].strftime('%H:%m')}</td>
                    </tr>
                    {f"<tr><th>Обратный рейс</th><td>{booking_data['r_departure_date'].strftime('%Y-%m-%d')} в {booking_data['r_departure_date'].strftime('%H:%m')}</td></tr>" if 'r_departure_date' in booking_data else ""}
                </table>
            </div>
            
            <!-- Секция с пассажирами -->
            <div class="passengers-section">
                <h3>👥 Информация о пассажирах</h3>
                {passengers_html}
            </div>
            
            <div class="important">
                <h3>⚠️ Важная информация бронирования</h3>
                <ul>
                    <li>Все пассажиры должны прибыть в аэропорт за 2.5 часа до вылета</li>
                    <li>При регистрации предъявите этот документ и удостоверения личности всех пассажиров</li>
                    <li>Регистрация группы заканчивается за 50 минут до вылета</li>
                    <li>Рекомендуем пройти онлайн-регистрацию за 24 часа до вылета</li>
                    <li>Места пассажиров будут расположены рядом, где это возможно</li>
                </ul>
            </div>
            
            <p>Спасибо, что выбрали наш сервис! Желаем приятного полета! ✈️</p>
        </div>
    </body>
    </html>
        """
        return html_template
    
    def _create_plain_text_template(self, booking_data: Dict) -> str:
        """Создание текстовой версии письма"""
        passengers_text = ""
        for i, passenger in enumerate(booking_data['passenger_data']['passengers'], 1):
            passengers_text += f"""
Пассажир {i}:
  ФИО: {passenger['firstName']} {passenger['lastName']} {passenger['surname']}
  Тип: {passenger['type']}
"""

        text_template = f"""
ПОДТВЕРЖДЕНИЕ БРОНИРОВАНИЯ АВИАБИЛЕТА

Номер бронирования: {booking_data['id']}

Ваше бронирование успешно подтверждено!

ИНФОРМАЦИЯ О РЕЙСЕ:
Маршрут: {booking_data['departure_city']} → {booking_data['arrival_city']}
Авиакомпания: {booking_data['airline']} {booking_data['flight_number']}
Дата вылета: {booking_data['departure_date'].strftime('%Y-%m-%d')} в {booking_data['departure_date'].strftime('%H:%m')}
Дата прибытия: {booking_data['arrival_date'].strftime('%Y-%m-%d')} в {booking_data['arrival_date'].strftime('%H:%m')}

ИНФОРМАЦИЯ О ПАССАЖИРАХ:
{passengers_text}

ВАЖНАЯ ИНФОРМАЦИЯ:
- Прибывайте в аэропорт за 2 часа до вылета
- Имейте при себе документ, удостоверяющий личность
- Регистрация заканчивается за 40 минут до вылета

Спасибо, что выбрали наш сервис!
        """
        return text_template
    
    def send_booking_confirmation(self, 
                                sender_email: str,
                                sender_password: str,
                                recipient_email: str,
                                booking_data: Dict) -> bool:
        """
        Отправка письма с подтверждением бронирования
        
        Args:
            sender_email: Email отправителя
            sender_password: Пароль отправителя
            recipient_email: Email получателя
            booking_data: Данные о бронировании
        
        Returns:
            bool: Успешность отправки
        """
        
        try:
            # Получаем настройки SMTP
            print(1)
            smtp_config = self._get_smtp_config(sender_email)
            print(2)
            # Создаем сообщение
            msg = MIMEMultipart('alternative')
            msg['From'] = sender_email
            msg['To'] = recipient_email
            msg['Subject'] = f'Подтверждение бронирования #{booking_data["id"]}'
            msg['Date'] = formatdate(localtime=True)
            
            # Добавляем текстовую и HTML версии
            print(3)
            text_part = MIMEText(self._create_plain_text_template(booking_data), 'plain', 'utf-8')
            print('11')
            html_part = MIMEText(self._create_booking_html_template(booking_data), 'html', 'utf-8')
            print(4)
            msg.attach(text_part)
            msg.attach(html_part)
            print(smtp_config)
            # Устанавливаем соединение и отправляем
            server = smtplib.SMTP(smtp_config['server'], smtp_config['port'])
            print(6)
            server.starttls()
            print(7)
            server.login(sender_email, sender_password)
            print(8)
            server.send_message(msg)
            server.quit()
            
            print(f"Письмо с подтверждением бронирования #{booking_data['id']} отправлено на {recipient_email}")
            return True
            
        except Exception as e:
            print(f"Ошибка при отправке письма: {e}")
            return False

# Создаем экземпляр класса для использования

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\models.py
=============================
from django.db import models

# Create your models here.

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\tests.py
=============================
from django.test import TestCase

# Create your tests here.

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\urls.py
=============================
from django.urls import path
from . import views

app_name = 'booking'

urlpatterns = [
    path('<int:offer_id>/', views.BookingView.as_view(), name='booking_index'),
    path('booking_success/<int:booking_id>', views.BookingSuccessView.as_view(), name='booking_success'),
    path('booking_data/<int:booking_id>/', views.BookingDataView.as_view(), name='booking_data'),
]

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\views.py
=============================
from django.shortcuts import render
from django.views.generic import TemplateView
from flights.models import FlightOffer, FlightSegment, Booking
from django.urls import reverse
from django.forms.models import model_to_dict
from django.http import HttpResponseRedirect
from dotenv import load_dotenv
import os
from .email_sender import FlightBookingEmailSender

load_dotenv()

# Create your views here.


def index(request, offer_id):
    return render(request, 'booking/booking.html')


class BookingView(TemplateView):
    template_name = 'booking/booking.html'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        offer_id = self.kwargs.get('offer_id')
        try:
            offer = FlightOffer.objects.get(id=offer_id)
            context['offer'] = offer
            
            # Получаем сегменты рейса
            segments = FlightSegment.objects.filter(offer=offer, there_seg=True)
            context['segments'] = segments
            context['return_segments'] = FlightSegment.objects.filter(offer=offer, there_seg=False)
            #print(FlightSegment.objects.filter(offer=offer, there_seg=False))

            #print(segments.first().dep_airport)

            context['dep_airport'] = segments.first().dep_airport
            context['dep_iataCode'] = segments.first().dep_iataCode

            context['arr_airport'] = segments.last().arr_airport
            context['arr_iataCode'] = segments.last().arr_iataCode
            
            # Получаем информацию о количестве пассажиров
            flight_request = offer.flightRequest
            adults = flight_request.adults
            children = flight_request.children or 0
            infants = flight_request.infants or 0
            
            # Добавляем в контекст количество пассажиров
            context['adults'] = adults
            context['children'] = children
            context['infants'] = infants
            
            # Добавляем диапазоны для циклов в шаблоне
            context['adults_range'] = range(1, adults + 1)
            context['children_range'] = range(1, children + 1)
            context['infants_range'] = range(1, infants + 1)
            
            # Также можно проверить данные о пассажирах в JSON поле data предложения
            if offer.data and 'travelerPricings' in offer.data:
                context['traveler_pricings'] = offer.data['travelerPricings']
                context['traveler_count'] = len(offer.data['travelerPricings'])
            
        except FlightOffer.DoesNotExist:
            context['error'] = 'Предложение не найдено'
        return context
        
    def post(self, request, *args, **kwargs):
        offer_id = self.kwargs.get('offer_id')
        actual_price = request.POST.get('actualPrice')
        try:
            offer = FlightOffer.objects.get(id=offer_id)
            
            # Проверяем, изменилась ли цена
            if actual_price and float(actual_price) != float(offer.totalPrice):
                # Обновляем цену в базе данных
                offer.totalPrice = actual_price
                offer.save()
            
            # Обрабатываем данные формы
            form_data = request.POST
            
            # Собираем данные о пассажирах
            passengers = []
            adults_count = int(form_data.get('adults_count', 0))
            children_count = int(form_data.get('children_count', 0))
            infants_count = int(form_data.get('infants_count', 0))
            
            # Проверяем данные о пассажирах в JSON поле data предложения
            traveler_types = {}
            if offer.data and 'travelerPricings' in offer.data:
                for i, traveler in enumerate(offer.data['travelerPricings']):
                    traveler_type = traveler.get('travelerType', '')
                    if traveler_type not in traveler_types:
                        traveler_types[traveler_type] = 0
                    traveler_types[traveler_type] += 1
                
                # Проверяем, что количество пассажиров совпадает
                expected_adults = traveler_types.get('ADULT', 0)
                expected_children = traveler_types.get('CHILD', 0)
                expected_infants = traveler_types.get('HELD_INFANT', 0) + traveler_types.get('SEATED_INFANT', 0)
                
                if adults_count != expected_adults or children_count != expected_children or infants_count != expected_infants:
                    # Если не совпадает, можно логировать или предупредить
                    print(f"Warning: Passenger count mismatch. Form: {adults_count}/{children_count}/{infants_count}, Expected: {expected_adults}/{expected_children}/{expected_infants}")
            
            # Собираем данные о взрослых пассажирах
            for i in range(1, adults_count + 1):
                passenger = {
                    'id': i,
                    'type': 'ADULT',
                    'firstName': form_data.get(f'adult_{i}_first_name', ''),
                    'lastName': form_data.get(f'adult_{i}_last_name', ''),
                    'surname': form_data.get(f'adult_{i}_surname'),
                    'dateOfBirth': form_data.get(f'adult_{i}_dob', ''),
                    'dateOfBirth': form_data.get(f'adult_{i}_dob', ''),
                    'gender': form_data.get(f'adult_{i}_gender', ''),
                    'documentType': form_data.get(f'adult_{i}_document_type', ''),
                    'documentNumber': form_data.get(f'adult_{i}_document_number', '')
                }
                if passenger['documentType'] == 'ID_CARD':
                    passenger['documentSeries'] = form_data.get(f'adult_{i}_document_series', '')
                    passenger['twoLetters'] = form_data.get(f'adult_{i}_two_letters', '')
                passengers.append(passenger)
            # Собираем данные о детях
            for i in range(1, children_count + 1):
                passenger = {
                    'id': adults_count + i,
                    'type': 'CHILD',
                    'firstName': form_data.get(f'child_{i}_first_name', ''),
                    'lastName': form_data.get(f'child_{i}_last_name', ''),
                    'surname': form_data.get(f'child_{i}_surname'),
                    'dateOfBirth': form_data.get(f'child_{i}_dob', ''),
                    'dateOfBirth': form_data.get(f'child_{i}_dob', ''),
                    'gender': form_data.get(f'child_{i}_gender', ''),
                    'documentType': form_data.get(f'child_{i}_document_type', ''),
                    'documentNumber': form_data.get(f'child_{i}_document_number', '')
                }
                if passenger['documentType'] == 'ID_CARD':
                    passenger['documentSeries'] = form_data.get(f'child_{i}_document_series', '')
                    passenger['twoLetters'] = form_data.get(f'child_{i}_two_letters', '')
                passengers.append(passenger)
            # Собираем данные о младенцах
            for i in range(1, infants_count + 1):
                passenger = {
                    'id': adults_count + children_count + i,
                    'type': 'INFANT',
                    'firstName': form_data.get(f'infant_{i}_first_name', ''),
                    'lastName': form_data.get(f'infant_{i}_last_name', ''),
                    'surname': form_data.get(f'infant_{i}_surname'),
                    'dateOfBirth': form_data.get(f'infant_{i}_dob', ''),
                    'dateOfBirth': form_data.get(f'infant_{i}_dob', ''),
                    'gender': form_data.get(f'infant_{i}_gender', ''),
                    'documentType': form_data.get(f'infant_{i}_document_type', ''),
                    'documentNumber': form_data.get(f'infant_{i}_document_number', '')
                }
                if passenger['documentType'] == 'ID_CARD':
                    passenger['documentSeries'] = form_data.get(f'infant_{i}_document_series', '')
                    passenger['twoLetters'] = form_data.get(f'infant_{i}_two_letters', '')
                passengers.append(passenger)
            # Получаем контактные данные
            contact_email = form_data.get('contact_email', '')
            contact_phone = 89000000000#form_data.get('contact_phone', '')
            
            # Создаем запись о бронировании
            
            booking = Booking(
                offer=offer,
                total_price=offer.totalPrice,
                currency_code=offer.currencyCode,
                passenger_data={'passengers': passengers},
                contact_email=contact_email,
                contact_phone=contact_phone
            )
            # Если пользователь авторизован, связываем бронирование с ним
            if request.user.is_authenticated:
                booking.user = request.user
            else:
                # Иначе используем ключ сессии
                booking.session_key = request.session.session_key
            
            booking.save()
            
            # Перенаправляем на страницу успешного бронирования
            
            return HttpResponseRedirect(reverse('booking:booking_success', kwargs={'booking_id': booking.id}))
            
        except FlightOffer.DoesNotExist:
            print('Offer not found')
            context = self.get_context_data(**kwargs)
            context['error'] = 'Предложение не найдено'
            return self.render_to_response(context)
        except Exception as e:
            print(f'Error processing booking: {str(e)}')
            context = self.get_context_data(**kwargs)
            context['error'] = f'Ошибка при обработке бронирования: {str(e)}'
            return self.render_to_response(context)
        

class BookingSuccessView(TemplateView):
    template_name = 'booking/booking_success.html'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        booking_id = self.kwargs.get('booking_id')
        
        try:
            booking = Booking.objects.get(id=booking_id)
            
            # Добавляем информацию о бронировании в контекст
            context['booking'] = booking
            
            context['offer'] = booking.offer
            
            # Получаем сегменты рейса
            segments = FlightSegment.objects.filter(offer=booking.offer, there_seg=True)
            context['segments'] = segments
            context['return_segments'] = FlightSegment.objects.filter(offer=booking.offer, there_seg=False)

            context['dep_airport'] = segments.first().dep_airport
            context['dep_iataCode'] = segments.first().dep_iataCode

            context['arr_airport'] = segments.last().arr_airport
            context['arr_iataCode'] = segments.last().arr_iataCode
            
            # Получаем данные о пассажирах
            context['passengers'] = booking.passenger_data.get('passengers', [])
            
            # Если пользователь авторизован, проверяем, что бронирование принадлежит ему
            if self.request.user.is_authenticated and booking.user and booking.user != self.request.user:
                context['error'] = 'У вас нет доступа к этому бронированию'
                
        except Exception as e:
            context['error'] = f'Бронирование не найдено или произошла ошибка: {str(e)}'
            
        return context
    
    def get(self, request, *args, **kwargs):
        booking_id = self.kwargs.get('booking_id')
        booking = Booking.objects.get(id=booking_id)
        booking_data = model_to_dict(booking)
        f_segment = FlightSegment.objects.filter(offer=booking.offer, there_seg=True).first()
        l_segment = FlightSegment.objects.filter(offer=booking.offer, there_seg=True).last()
        booking_data['terminal'] = f_segment.dep_terminal
        booking_data['departure_city'] = f_segment.dep_airport
        booking_data['arrival_city'] = l_segment.arr_airport
        booking_data['airline'] = f_segment.carrierCode
        booking_data['flight_number'] = f_segment.aircraftCode
        booking_data['departure_date'] = booking.offer.dep_duration
        booking_data['arrival_date'] = booking.offer.arr_duration
        if not(booking.offer.oneWay):
            f_segment = FlightSegment.objects.filter(offer=booking.offer, there_seg=False).first()
            l_segment = FlightSegment.objects.filter(offer=booking.offer, there_seg=False).last()
            booking_data['r_departure_date'] = f_segment.dep_dateTime
            booking_data['r_arrival_date'] = l_segment.arr_dateTime
        if booking.status == 'PENDING':
            email_sender = FlightBookingEmailSender()
            email_sender.send_booking_confirmation(
                sender_email=os.getenv('GMAIL'),
                sender_password=os.getenv('GMAIL_PASSWORD'), 
                recipient_email=booking.contact_email,
                booking_data=booking_data
            )
            booking.status = 'CONFIRMED'
            booking.save()
        return super().get(request)
    

class BookingDataView(TemplateView):
    template_name = 'booking/booking_data.html'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        booking_id = self.kwargs.get('booking_id')
        
        try:
            booking = Booking.objects.get(id=booking_id)
            
            # Добавляем информацию о бронировании в контекст
            context['booking'] = booking
            
            context['offer'] = booking.offer
            
            # Получаем сегменты рейса
            segments = FlightSegment.objects.filter(offer=booking.offer, there_seg=True)
            context['segments'] = segments
            context['return_segments'] = FlightSegment.objects.filter(offer=booking.offer, there_seg=False)

            context['dep_airport'] = segments.first().dep_airport
            context['dep_iataCode'] = segments.first().dep_iataCode

            context['arr_airport'] = segments.last().arr_airport
            context['arr_iataCode'] = segments.last().arr_iataCode
            
            # Получаем данные о пассажирах
            context['passengers'] = booking.passenger_data.get('passengers', [])
            
            # Если пользователь авторизован, проверяем, что бронирование принадлежит ему
            if self.request.user.is_authenticated and booking.user and booking.user != self.request.user:
                context['error'] = 'У вас нет доступа к этому бронированию'
                
        except Exception as e:
            context['error'] = f'Бронирование не найдено или произошла ошибка: {str(e)}'
            
        return context



=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\booking\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\management\commands\export_booking_data.py
=============================
# ------------------------------------------------------------------
# Django integration kit for the recommendation system
# Files included in this single code document (copy each section
# into the corresponding file in your Django `main` app):
# 1) management command: main/management/commands/export_booking_data.py
# 2) recsys helper module: main/recsys/predictor.py
# 3) Django view: main/views_recs.py
# 4) URL snippet: main/urls_recs.py (include in your main/urls.py)
# 5) small training launcher: scripts/train_recsys.py (standalone)
# 6) README section at the end with instructions
# ------------------------------------------------------------------

# -----------------------------
# File: main/management/commands/export_booking_data.py
# -----------------------------
from django.core.management.base import BaseCommand
from django.conf import settings
import os
import csv
from django.utils import timezone
from flights.models import Booking, FlightOffer
from user_management.models import CustomUser as User


class Command(BaseCommand):
    help = 'Export users, items and bookings to CSV for training the recommender'

    def add_arguments(self, parser):
        parser.add_argument('--outdir', type=str, default='recsys_data', help='Output directory')
        parser.add_argument('--limit-users', type=int, default=None, help='Limit number of users to export')

    def handle(self, *args, **options):
        outdir = options['outdir']
        limit_users = options['limit_users']
        os.makedirs(outdir, exist_ok=True)

        self.stdout.write(f'Exporting to {outdir}...')

        # Export users
        users_qs = User.objects.all().order_by('id')
        if limit_users:
            users_qs = users_qs[:limit_users]
        users_file = os.path.join(outdir, 'users.csv')
        with open(users_file, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            # header (extend if you have extra fields)
            writer.writerow(['user_id', 'is_staff', 'date_joined'])
            for u in users_qs:
                writer.writerow([u.id, getattr(u, 'is_staff', False), getattr(u, 'date_joined', '')])
        self.stdout.write(f'Users exported: {users_file}')

        # Export items (flights/offers)
        items_qs = FlightOffer.objects.select_related('flightRequest').all().order_by('id')
        items_file = os.path.join(outdir, 'offers.csv')
        with open(items_file, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            writer.writerow(['item_id', 'origin', 'destination', 'departure_date', 'duration', 'currencyCode', 'totalPrice'])
            for it in items_qs:
                writer.writerow([
                    it.id,
                    it.flightRequest.originLocationCode,
                    it.flightRequest.destinationLocationCode,
                    it.dep_duration.date(),  # дата вылета
                    it.duration,
                    it.currencyCode,
                    it.totalPrice
                ])
        self.stdout.write(f'Items exported: {items_file}')

        # Export bookings / interactions
        # Expected Booking fields: id, user (FK), item (FK), event_time (datetime), price_at_event, event_type, purchased
        bookings_qs = Booking.objects.select_related('user', 'offer').order_by('user_id', 'created_at')
        if limit_users:
            bookings_qs = bookings_qs.filter(user__in=users_qs)
        bookings_file = os.path.join(outdir, 'bookings.csv')
        with open(bookings_file, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)

            writer.writerow(['event_id', 'user_id', 'offer_id', 'created_at', 'total_price', 'currency_code', 'status'])
            for b in bookings_qs:
                writer.writerow([
                    b.id,
                    b.user.id if b.user else '',
                    b.offer.id,
                    b.created_at,
                    b.total_price,
                    b.currency_code,
                    b.status
                ])

        self.stdout.write(f'Bookings exported: {bookings_file}')
        self.stdout.write(self.style.SUCCESS('Export finished.'))





# -----------------------------
# README / INSTRUCTIONS
# -----------------------------
# 1) Place each "File:" section into the corresponding file path within your Django project.
#    - management command -> main/management/commands/export_booking_data.py
#    - predictor & model_stub -> main/recsys/
#    - views_recs.py and urls_recs.py -> main/
#    - scripts/train_recsys.py -> scripts/ (project root)
#
# 2) Adjust model field names if your models use different attributes. I left comments where
#    you should change attribute names (Item.origin, Booking.event_time, etc.).
#
# 3) Run the export command to produce CSVs:
#       python manage.py export_booking_data --outdir=recsys_data
#
# 4) Train a model locally using the training script:
#       python scripts/train_recsys.py --bookings=recsys_data/bookings.csv --items=recsys_data/items.csv --out=recsys_model.pth
#
# 5) Configure settings.py with absolute paths (optional):
#    RECSYS_MODEL_PATH = BASE_DIR / 'recsys_model.pth'
#    RECSYS_DATA_DIR = BASE_DIR / 'recsys_data'
#
# 6) Wire the URLs: include main/urls_recs.py in your project's url config or main/urls.py.
#
# 7) Test the endpoint (JSON):
#    GET /main/recommendations/123/  -> returns {"user_id":123, "recommendations": [item_ids...]}
#
# 8) For production inference, consider:
#    - exporting the model to TorchScript or ONNX
#    - running inference in a separate FastAPI service
#    - caching top-K per user and refreshing periodically
#
# Dependencies (pip):
#   pandas, numpy, torch, tqdm
#
# That's it — adapt the model architecture, negative sampling and metrics later when you
# have real logs. Good luck!

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\management\commands\train_recsys.py
=============================
from django.core.management.base import BaseCommand
from django.conf import settings
import os
import pandas as pd
import torch
from torch import nn
from torch.utils.data import DataLoader, Dataset
import numpy as np
from tqdm import tqdm

# Импорт модели из проекта
from flights.recsys.model_stub import RecModelForInference


class Command(BaseCommand):
    help = "Обучает рекомендательную модель на основе экспортированных CSV-файлов (bookings.csv и items.csv)."

    def add_arguments(self, parser):
        parser.add_argument(
            "--bookings",
            type=str,
            default=os.path.join(settings.BASE_DIR, "recsys_data", "bookings.csv"),
            help="Путь к bookings.csv",
        )
        parser.add_argument(
            "--items",
            type=str,
            default=os.path.join(settings.BASE_DIR, "recsys_data", "offers.csv"),
            help="Путь к offers.csv",
        )
        parser.add_argument(
            "--out",
            type=str,
            default=os.path.join(settings.BASE_DIR, "recsys_model.pth"),
            help="Путь для сохранения обученной модели",
        )
        parser.add_argument("--epochs", type=int, default=3, help="Количество эпох обучения")
        parser.add_argument("--batch-size", type=int, default=256, help="Размер батча")
        parser.add_argument("--max-len", type=int, default=30, help="Максимальная длина последовательности")

    def handle(self, *args, **options):
        
        class BookingsSeqDataset(Dataset):
            def __init__(self, bookings_csv, items_csv, max_len=30):
                bk = pd.read_csv(bookings_csv)
                items = pd.read_csv(items_csv)

                self.item_ids = items['item_id'].astype(int).tolist()
                self.item2idx = {iid: i for i, iid in enumerate(self.item_ids)}
                self.num_items = len(self.item2idx)
                self.PAD_IDX = self.num_items
                self.max_len = max_len

                self.user_seqs = []
                for uid, g in bk.sort_values('created_at').groupby('user_id'):
                    seq = [self.item2idx[i] for i in g['offer_id'].astype(int).tolist() if int(i) in self.item2idx]
                    if len(seq) < 2:
                        continue
                    self.user_seqs.append(seq)

            def __len__(self):
                return len(self.user_seqs)

            def __getitem__(self, idx):
                seq = self.user_seqs[idx]
                cut = np.random.randint(1, len(seq))
                src = seq[:cut]
                tgt = seq[cut]
                if len(src) > self.max_len:
                    src = src[-self.max_len:]
                pad = [self.PAD_IDX] * (self.max_len - len(src))
                src_padded = pad + src
                return torch.LongTensor(src_padded), torch.LongTensor([tgt])
            
            
        bookings_path = options["bookings"]
        items_path = options["items"]
        out_path = options["out"]
        epochs = options["epochs"]
        batch_size = options["batch_size"]
        max_len = options["max_len"]
        #print(items_path)

        if not os.path.exists(bookings_path) or not os.path.exists(items_path):
            self.stderr.write("❌ Не найдены CSV-файлы. Сначала выполните export_booking_data.")
            return

        self.stdout.write(f"📊 Загружаем данные из:\n  {bookings_path}\n  {items_path}")

        ds = BookingsSeqDataset(bookings_path, items_path, max_len=max_len)
        loader = DataLoader(ds, batch_size=batch_size, shuffle=True)

        model = RecModelForInference(num_items=ds.num_items, max_len=max_len)
        device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
        model.to(device)

        opt = torch.optim.Adam(model.parameters(), lr=1e-3)
        crit = nn.CrossEntropyLoss()

        for epoch in range(1, epochs + 1):
            model.train()
            pbar = tqdm(loader, desc=f"Эпоха {epoch}")
            total_loss = 0.0
            for src, tgt in pbar:
                src = src.to(device)
                tgt = tgt.squeeze(1).to(device)
                logits = model(src)
                loss = crit(logits, tgt)
                opt.zero_grad()
                loss.backward()
                opt.step()
                total_loss += loss.item()
                pbar.set_postfix(loss=total_loss / len(loader))

            self.stdout.write(f"Эпоха {epoch} завершена, средний loss = {total_loss/len(loader):.4f}")

        torch.save(model.state_dict(), out_path)
        self.stdout.write(self.style.SUCCESS(f"💾 Модель сохранена в {out_path}"))

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\migrations\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\recsys\model_stub.py
=============================
import torch
import torch.nn as nn

class RecModelForInference(nn.Module):
    def __init__(self, num_items, emb_dim=128, max_len=30, n_heads=4, n_layers=2):
        super().__init__()
        self.num_items = num_items
        self.max_len = max_len
        PAD_IDX = num_items
        self.item_emb = nn.Embedding(num_items+1, emb_dim, padding_idx=PAD_IDX)
        self.pos_emb = nn.Embedding(max_len, emb_dim)
        encoder_layer = nn.TransformerEncoderLayer(d_model=emb_dim, nhead=n_heads, dim_feedforward=emb_dim*4)
        self.transformer = nn.TransformerEncoder(encoder_layer, num_layers=n_layers)
        self.output = nn.Linear(emb_dim, num_items)

    def forward(self, src):
        # src: [B, max_len]
        B = src.size(0)
        positions = torch.arange(0, self.max_len, device=src.device).unsqueeze(0).repeat(B,1)
        x = self.item_emb(src) + self.pos_emb(positions)
        x = x.permute(1,0,2)
        out = self.transformer(x, src_key_padding_mask=(src==self.num_items))
        out = out.permute(1,0,2)
        last_idxs = (src != self.num_items).sum(dim=1) - 1
        last_repr = out[torch.arange(B), last_idxs]
        logits = self.output(last_repr)
        return logits
    

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\recsys\predictor.py
=============================
import os
import pandas as pd
import numpy as np
import torch
import torch.nn as nn

class Recommender:
    def __init__(self, model_cls, model_state_path, data_dir='recsys_data', device=None, max_len=30):
        self.data_dir = data_dir
        self.device = device or (torch.device('cuda') if torch.cuda.is_available() else torch.device('cpu'))
        self.max_len = max_len

        # load item mapping
        items_path = os.path.join(data_dir, 'offers.csv')
        if not os.path.exists(items_path):
            raise FileNotFoundError('items.csv not found in data_dir')
        items_df = pd.read_csv(items_path)
        self.item_ids = items_df['item_id'].astype(int).tolist()
        # mapping item_id -> index (0..N-1)
        self.item2idx = {iid: i for i, iid in enumerate(self.item_ids)}
        self.idx2item = {i: iid for iid, i in self.item2idx.items()}
        self.num_items = len(self.item2idx)

        # instantiate model and load weights
        self.model = model_cls(num_items=self.num_items, max_len=self.max_len)
        self.model.load_state_dict(torch.load(model_state_path, map_location=self.device))
        self.model.to(self.device)
        self.model.eval()

        # pre-load bookings to build user sequences quickly
        bookings_path = os.path.join(data_dir, 'bookings.csv')
        if os.path.exists(bookings_path):
            self.bookings = pd.read_csv(bookings_path)
        else:
            self.bookings = pd.DataFrame(columns=['user_id','offer_id','created_at'])

    def _build_user_seq(self, user_id):
        # returns list of item indices sorted by time
        df = self.bookings[self.bookings['user_id'] == int(user_id)].sort_values('created_at')
        seq = [self.item2idx[i] for i in df['offer_id'].astype(int).tolist() if int(i) in self.item2idx]
        return seq

    def recommend_for_user(self, user_id, top_k=10):
        seq = self._build_user_seq(user_id)
        # prepare input (pad left with PAD index = num_items)
        PAD_IDX = self.num_items
        if len(seq) > self.max_len:
            seq = seq[-self.max_len:]
        pad = [PAD_IDX] * (self.max_len - len(seq))
        src = torch.LongTensor([pad + seq]).to(self.device)
        with torch.no_grad():
            logits = self.model(src)  # shape [1, num_items]
            scores = logits.squeeze(0).cpu().numpy()
            top_idx = np.argsort(-scores)[:top_k]
            top_item_ids = [self.idx2item[i] for i in top_idx]
        return top_item_ids

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\static\flights\css\base.css
=============================
/* Основные стили для проекта bilety_ru */

/* Стили для карточек рейсов */

:root {
    --primary-color: #4a90e2;
    --secondary-color: #f5f7fa;
    --accent-color: #ff6b6b;
    --text-color: #333;
    --light-text: #777;
    --border-radius: 8px;
    --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

body {
    font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
    color: var(--text-color);
    background-color: #f8f9fa;
    line-height: 1.6;
}

.navbar {
    background-color: white;
    box-shadow: var(--box-shadow);
}

.navbar-brand {
    font-weight: 700;
    color: var(--primary-color) !important;
    font-size: 1.5rem;
}

.nav-link {
    color: var(--text-color) !important;
    font-weight: 500;
    transition: color 0.2s;
}

.nav-link:hover {
    color: var(--primary-color) !important;
}

.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    border-radius: var(--border-radius);
    font-weight: 500;
    padding: 0.5rem 1.5rem;
    transition: all 0.2s;
}

.btn-primary:hover {
    background-color: #3a80d2;
    border-color: #3a80d2;
    transform: translateY(-2px);
}

.btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
    border-radius: var(--border-radius);
    font-weight: 500;
    padding: 0.5rem 1.5rem;
    transition: all 0.2s;
}

.btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.container {
    padding: 2rem 1rem;
}

/* Стили для аватара пользователя */

.avatar-dropdown {
    cursor: pointer;
    position: relative;
}

.avatar-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-color);
}

.dropdown-menu {
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    border: none;
    margin-top: 0.5rem;
}

.dropdown-item {
    padding: 0.5rem 1.5rem;
    color: var(--text-color);
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: var(--secondary-color);
    color: var(--primary-color);
}


=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\static\flights\css\search.css
=============================


.card {
    border-radius: var(--border-radius);
    border: none;
    box-shadow: var(--box-shadow);
    transition: transform 0.3s;
}

.card:hover {
    transform: translateY(-5px);
}

.flight-card {
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin: 10px;
    transition: transform 0.3s;
}
.flight-card:hover {
    transform: translateY(-5px);
}
.flight-header {
    background-color: #f8f9fa;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    padding: 15px;
    border-bottom: 1px solid #eee;
}
.flight-body {
    padding: 20px;
}
.flight-price {
    font-size: 24px;
    font-weight: bold;
    color: #28a745;
}
.flight-segment {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px dashed #eee;
    gap: 15px;
}
.flight-segment:last-child {
    border-bottom: none;
}
.airline-logo {
    height: 30px;
    margin-right: 10px;
}
.flight-duration {
    color: #6c757d;
    font-size: 14px;
}
.flight-arrow {
    color: #007bff;
    font-size: 20px;
    margin: 0 10px;
}
.book-button {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    font-weight: bold;
    transition: background-color 0.3s;
}
.book-button:hover {
    background-color: #0056b3;
}

.context-segment {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 90px;
}

/* Стили для формы поиска */

.search-form {
    background-color: #f8f9fa;
    /*padding: 20px;*/
    border-radius: 10px;
    /*margin-bottom: 30px;*/
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
}

.search-form .form-group {
    min-width: 50px;
    flex: 1 1 220px;
}


/* Стили для автозаполнения */

.autocomplete {
    position: relative;
    width: 70%;
}

.autocomplete-items {
    position: absolute;
    border: 1px solid #d4d4d4;
    border-radius: 0 0 4px 4px;
    border-top: none;
    z-index: 99;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 250px;
    overflow-y: auto;
    background-color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.autocomplete-items div {
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.2s;
    border-bottom: 1px solid #f3f3f3;
}

.autocomplete-items div:last-child {
    border-bottom: none;
    border-radius: 0 0 4px 4px;
}

.autocomplete-items div:hover {
    background-color: #f1f8ff;
}

.autocomplete-items .airport-item {
    display: flex;
    flex-direction: column;
}

.autocomplete-items .airport-item strong {
    color: #007bff;
    font-size: 16px;
    margin-bottom: 2px;
}

.autocomplete-items .loading-item {
    color: #6c757d;
    text-align: center;
    padding: 15px;
    font-style: italic;
}

.autocomplete-items .error-item {
    color: #dc3545;
    text-align: center;
    padding: 15px;
}

.autocomplete-items .no-results {
    color: #6c757d;
    text-align: center;
    padding: 15px;
    font-style: italic;
}

/* Стили для блока с параметрами сортировки */

.sorting-options {
    background-color: #f0f8ff; /* Светло-голубой фон для отличия от основной формы */
    border-radius: 10px;
    margin-top: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    border-left: 4px solid #007bff; /* Синяя полоса слева для визуального отличия */
}

.sorting-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #e3f2fd;
}

.sorting-header h5 {
    margin: 0;
    color: #0056b3;
    font-weight: 600;
}

.sorting-body {
    padding: 20px;
    display: none; /* По умолчанию скрыт, будет показываться по клику */
}

.sorting-body.active {
    display: block;
}

#sortingForm .form-group label {
    color: #0056b3;
    font-size: 0.9rem;
    font-weight: 500;
}

#sortingForm select, #sortingForm input {
    border: 1px solid #b8daff;
    background-color: #fff;
}

#sortingForm select:focus, #sortingForm input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

#sortingForm select[multiple] {
    height: 100px;
}

#applySorting, #resetSorting {
    margin: 5px;
}

/* Добавим скрипт для переключения видимости блока сортировки */
@media (max-width: 768px) {
    .sorting-options .form-group {
        margin-bottom: 15px;
    }
}

.prices-container {
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 5px;
}

.price-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.price-item:hover {
    background-color: #f5f5f5;
}

.price-item:last-child {
    border-bottom: none;
}

.price {
    font-weight: bold;
    color: #e74c3c;
}

.route, .time {
    font-size: 0.9em;
    color: #666;
}

.loading, .message {
    padding: 10px;
    text-align: center;
    color: #666;
    font-style: italic;
}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\static\flights\js\search.js
=============================
// Функция для автозаполнения полей поиска аэропортов
/*
class FlightSearch {
    constructor() {
        this.origin = document.getElementById('id_originLocationCode');
        this.destination = document.getElementById('id_destinationLocationCode');
        this.departureDate = document.getElementById('id_departureDate');
        this.returnDate = document.getElementById('id_returnDate');
        this.departurePrices = document.getElementById('departure-prices');
        this.returnPrices = document.getElementById('return-prices');
        this.flightData = {
            'origin': null,
            'destination': null
        }
        this.initEventListeners();
    }

    initEventListeners() {
        // Запрос цен при фокусе на поле даты вылета
        this.departureDate.addEventListener('focus', () => {
            this.fetchPrices('departure');
        });

        // Запрос цен при фокусе на поле даты возвращения
        this.returnDate.addEventListener('focus', () => {
            this.fetchPrices('return');
        });

        // Обновление цен при изменении городов
        this.origin.addEventListener('change', this.clearPrices.bind(this));
        this.destination.addEventListener('change', this.clearPrices.bind(this));
    }

    async fetchPrices(type) {
        const origin = this.origin.value.trim();
        const destination = this.destination.value.trim();
        const response = {};

        if (!origin || !destination) {
            this.showMessage('Введите города вылета и прилета', type);
            return;
        }

        const requestData = {
            origin: origin,
            destination: destination
        };

        // Добавляем дату только если она выбрана
        if (type === 'departure' && this.departureDate.value) {
            requestData.departure_date = this.departureDate.value;
        } else if (type === 'return' && this.returnDate.value) {
            requestData.return_date = this.returnDate.value;
        }
        
        
        try {
            this.showLoading(type);

            
            $.ajax({
                url: `/api/flight-prices/?origin=${requestData.origin}&destination=${requestData.destination}`,
                type: 'GET',
                dataType: 'json',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }  
            })
            .done(function(data){
                console.log(data.origin, data.destination);
                response.origin = data.origin;
                response.destination = data.destination;
                console.log(response);

                const container = type === 'departure' ? this.departurePrices : this.returnPrices;
                //console.log(flights)
                if (response.length === 0) {
                    container.innerHTML = '<div class="price-item">Рейсов не найдено</div>';
                    return;
                }
                let html = '<div class="prices-container">';
                
                response.forEach(flight => {
                    const departure = flight.itineraries[0];
                    const price = flight.price;
                    
                    html += `
                        <div class="price-item">
                            <div class="price">${price.total} ${price.currency}</div>
                            <div class="route">${departure.segments[0].departure_airport} → ${departure.segments[0].arrival_airport}</div>
                            <div class="time">${formatTime(departure.segments[0].departure_time)}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            })
            
            //console.log(data)
            //this.displayPrices(data, type);

            const response = await fetch('/api/flight-prices/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();

            if (response.ok) {
                this.displayPrices(data, type);
            } else {
                this.showMessage(`Ошибка: ${data.error}`, type);
            }
                
        } catch (error) {
            this.showMessage('Ошибка соединения', type);
            console.error('Error:', error);
        }
    }

    displayPrices(flights, type) {
        const container = type === 'departure' ? this.departurePrices : this.returnPrices;
        //console.log(flights)
        if (flights.length === 0) {
            container.innerHTML = '<div class="price-item">Рейсов не найдено</div>';
            return;
        }

        let html = '<div class="prices-container">';
        
        flights.forEach(flight => {
            const departure = flight.itineraries[0];
            const price = flight.price;
            
            html += `
                <div class="price-item">
                    <div class="price">${price.total} ${price.currency}</div>
                    <div class="route">${departure.segments[0].departure_airport} → ${departure.segments[0].arrival_airport}</div>
                    <div class="time">${this.formatTime(departure.segments[0].departure_time)}</div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    showMessage(message, type) {
        const container = type === 'departure' ? this.departurePrices : this.returnPrices;
        container.innerHTML = `<div class="message">${message}</div>`;
    }

    showLoading(type) {
        const container = type === 'departure' ? this.departurePrices : this.returnPrices;
        container.innerHTML = '<div class="loading">Поиск цен...</div>';
    }

    clearPrices() {
        this.departurePrices.innerHTML = '';
        this.returnPrices.innerHTML = '';
    }

    getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
}
*/
document.addEventListener('DOMContentLoaded', function() {
    //new FlightSearch();
    const originInput = document.getElementById('id_originLocationCode');
    const destinationInput = document.getElementById('id_destinationLocationCode');
    const originList = document.getElementById('originList');
    const destinationList = document.getElementById('destinationList');
    let id_user = document.getElementById('id_user').value;
    var recommendetions = {};

    $.ajax({
        url: `/recommendations/${id_user}`,
        type: 'GET',
        dataType: 'json',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).done(function(data) {
        console.log(data);
        if (!data) {
                //console.error('Error:', data.error);
                console.log('error');
                return;
            }
        recommendetions = data;
    }).fail(function() {
        console.log('error in ajax');
    })

    function getRecommendetions(resultsList) {
        /*
        const loadingItem = document.createElement('div');
        loadingItem.textContent = 'Поиск аэропортов...';
        loadingItem.className = 'loading-item';
        resultsList.innerHTML = '';
        resultsList.appendChild(loadingItem);
        */
        if (recommendetions) {
            recommendetions.data.forEach(airport => {
                const item = document.createElement('div');
                item.className = 'airport-item';
                const cityInfo = airport.cityName ? `${airport.cityName}, ` : '';
                item.innerHTML = `<strong>${airport.iataCode}</strong> - ${cityInfo}`;
                
                item.addEventListener('click', function() {
                    destinationInput.value = airport.iataCode;
                    resultsList.innerHTML = '';
                });
                resultsList.appendChild(item);
            })
        }
    }
    
    // Функция для поиска аэропортов
    function searchAirports(query, resultsList) {
        if (query.length < 2) {
            resultsList.innerHTML = '';
            return;
        }
        
        // Отображаем индикатор загрузки
        const loadingItem = document.createElement('div');
        loadingItem.textContent = 'Поиск аэропортов...';
        loadingItem.className = 'loading-item';
        resultsList.innerHTML = '';
        resultsList.appendChild(loadingItem);
        
        // Используем правильный URL для API поиска аэропортов и jQuery AJAX
        $.ajax({
            url: `/api/airports/?keyword=${encodeURIComponent(query)}`,
            type: 'GET',
            dataType: 'json',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .done(function(data) {
            resultsList.innerHTML = '';

            if (!data.success) {
                console.error('Error:', data.error);
                const errorItem = document.createElement('div');
                errorItem.textContent = 'Ошибка поиска аэропортов';
                errorItem.className = 'error-item';
                resultsList.appendChild(errorItem);
                return;
            }
            
            if (data.airports && data.airports.length > 0) {
                data.airports.forEach(airport => {
                    const item = document.createElement('div');
                    item.className = 'airport-item';
                    const cityInfo = airport.cityName ? `${airport.cityName}, ` : '';
                    item.innerHTML = `<strong>${airport.iataCode}</strong> - ${cityInfo}`;
                    
                    item.addEventListener('click', function() {
                        if (resultsList === originList) {
                            originInput.value = airport.iataCode;
                        } else {
                            destinationInput.value = airport.iataCode;
                        }
                        resultsList.innerHTML = '';
                    });
                    resultsList.appendChild(item);
                });
            } else {
                const item = document.createElement('div');
                item.textContent = 'Аэропорты не найдены';
                item.className = 'no-results';
                resultsList.appendChild(item);
            }
        })
        .fail(function(error) {
            console.error('Error:', error);
            resultsList.innerHTML = '';
            const errorItem = document.createElement('div');
            errorItem.textContent = 'Ошибка соединения с сервером';
            errorItem.className = 'error-item';
            resultsList.appendChild(errorItem);
        });
    }
    
    // Обработчики событий для полей ввода
    if (originInput) {
        originInput.addEventListener('input', function() {
            searchAirports(this.value, originList);
        });
    }
    
    if (destinationInput) {
        destinationInput.addEventListener('click', function() {
            getRecommendetions(destinationList);
        })
        destinationInput.addEventListener('input', function() {
            searchAirports(this.value, destinationList);
        });
    }
    
    // Скрытие списков при клике вне полей
    document.addEventListener('click', function(event) {
        if (!originInput.contains(event.target) && !originList.contains(event.target)) {
            originList.innerHTML = '';
        }
        if (!destinationInput.contains(event.target) && !destinationList.contains(event.target)) {
            destinationList.innerHTML = '';
        }
    });
    
    // Функциональность для блока параметров сортировки
    const toggleSortingBtn = document.getElementById('toggleSortingOptions');
    const sortingBody = document.getElementById('sortingBody');
    const applySortingBtn = document.getElementById('applySorting');
    const resetSortingBtn = document.getElementById('resetSorting');
    
    if (toggleSortingBtn && sortingBody) {
        toggleSortingBtn.addEventListener('click', function() {
            if (sortingBody.classList.contains('active')) {
                sortingBody.classList.remove('active');
                toggleSortingBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Показать опции';
            } else {
                sortingBody.classList.add('active');
                toggleSortingBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Скрыть опции';
            }
        });
    }
    
    // Обработчик применения параметров сортировки
    if (applySortingBtn) {
        applySortingBtn.addEventListener('click', function() {
            // Получаем значения параметров сортировки
            const sortBy = document.getElementById('sortBy').value;
            const maxPrice = document.getElementById('maxPrice').value;
            const maxStops = document.getElementById('maxStops').value;
            const airlinesSelect = document.getElementById('airlines');
            const selectedAirlines = Array.from(airlinesSelect.selectedOptions).map(option => option.value);
            
            // Здесь будет логика применения сортировки к результатам
            console.log('Применяем сортировку:', {
                sortBy,
                maxPrice,
                maxStops,
                selectedAirlines
            });
            
            // Пример сортировки результатов (в реальном приложении нужно реализовать полноценную логику)
            sortFlightResults(sortBy, maxPrice, maxStops, selectedAirlines);
        });
    }
    
    // Обработчик сброса параметров сортировки
    if (resetSortingBtn) {
        resetSortingBtn.addEventListener('click', function() {
            // Сбрасываем значения формы сортировки
            document.getElementById('sortingForm').reset();
            
            // Возвращаем исходную сортировку результатов
            console.log('Сбрасываем параметры сортировки');
            resetSortingResults();
        });
    }
    
    // Функция для сортировки результатов поиска
    function sortFlightResults(sortBy, maxPrice, maxStops, selectedAirlines) {
        const flightResults = document.getElementById('flightResults');
        if (!flightResults) return;
        
        const flightCards = Array.from(flightResults.querySelectorAll('.flight-card'));
        
        // Сортировка по выбранному критерию
        flightCards.sort((a, b) => {
            // Получаем данные для сортировки
            const priceA = parseFloat(a.querySelector('.flight-price').textContent.trim().split(' ')[0]);
            const priceB = parseFloat(b.querySelector('.flight-price').textContent.trim().split(' ')[0]);
            
            // Сортировка по цене
            if (sortBy === 'price_asc') {
                return priceA - priceB;
            } else if (sortBy === 'price_desc') {
                return priceB - priceA;
            }
            
            // Здесь можно добавить другие критерии сортировки
            // Например, по длительности, времени вылета и т.д.
            
            return 0;
        });
        
        // Фильтрация по максимальной цене
        let filteredCards = flightCards;
        if (maxPrice && maxPrice > 0) {
            filteredCards = filteredCards.filter(card => {
                const price = parseFloat(card.querySelector('.flight-price').textContent.trim().split(' ')[0]);
                return price <= maxPrice;
            });
        }
        
        // Очищаем и добавляем отсортированные карточки
        flightResults.innerHTML = '';
        filteredCards.forEach(card => {
            flightResults.appendChild(card);
        });
        
        // Если нет результатов после фильтрации
        if (filteredCards.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'col-12 text-center my-4';
            noResults.innerHTML = '<p class="text-muted">Нет результатов, соответствующих выбранным параметрам</p>';
            flightResults.appendChild(noResults);
        }
    }
    
    // Функция для сброса сортировки
    function resetSortingResults() {
        // В реальном приложении здесь можно восстановить исходный порядок результатов
        // или перезагрузить их с сервера
        location.reload(); // Временное решение - перезагрузка страницы
    }
});

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\templates\flights\base.html
=============================
<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Билеты.ру - Поиск и бронирование авиабилетов{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <!-- Font Awesome для иконок -->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">-->
    <!-- Пользовательские стили -->
    <link rel="stylesheet" href="{% static 'flights/css/base.css' %}">
    <style>
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>

    <!-- Навигационная панель -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="{% url 'flights:home' %}">
                <i class="fas fa-plane-departure mr-2"></i>Билеты.ру
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <!--<ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'flights:home' %}">Главная</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Спецпредложения</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Помощь</a>
                    </li>
                </ul>-->
                
                <div class="ml-auto">
                    {% if user.is_staff %}
                        <a href="{% url 'admin:index' %}" class="btn btn-warning mr-2" target="_blank">
                            <i class="fas fa-tools mr-1"></i>Админ-панель
                        </a>
                    {% endif %}
                    {% if request.user.is_authenticated %}
                        <!-- Аватар с выпадающим меню для авторизованных пользователей -->
                        <div class="dropdown avatar-dropdown">
                            <div class="d-flex align-items-center" id="userDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="ml-2 d-none d-md-inline">{{ user.email }}</span>
                            </div>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="{% url 'user_management:profile' %}">
                                    <i class="fas fa-user mr-2"></i>История бронирований
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="{% url 'user_management:logout' %}">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Выйти
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <!-- Кнопки для неавторизованных пользователей -->
                        <a href="{% url 'user_management:signin' %}" class="btn btn-outline-primary mr-2">
                            <i class="fas fa-sign-in-alt mr-1"></i>Войти
                        </a>
                        <a href="{% url 'user_management:signup' %}" class="btn btn-primary">
                            <i class="fas fa-user-plus mr-1"></i>Регистрация
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <main class="container">
        {% if messages %}
            <div class="messages mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>    
    {% block extra_js %}{% endblock %}
</body>
</html>

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\templates\flights\search.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Поиск авиабилетов - Билеты.ру{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'flights/css/search.css' %}">
{% endblock %}

{% block content %}
<input type="hidden" name="id_user" id="id_user" value="{{ user.id }}">
<div class="row">
    {{ data }}
    <div>
        <h2 class="mb-4">Поиск авиабилетов</h2>
        <form method="post" id="cityForm">
            {% csrf_token %}
            <div class="search-form">
                <div class="form-group col-md-4">
                    {{ form.currencyCode.label }}:
                    {{ form.currencyCode }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.originLocationCode.label }}:
                    <div class="autocomplete">
                        {{ form.originLocationCode }}
                        <div id="originList" class="autocomplete-items"></div>
                    </div>
                </div>
                <div class="form-group col-md-4">
                    {{ form.destinationLocationCode.label }}:
                    <div class="autocomplete">
                        {{ form.destinationLocationCode }}
                        <div id="destinationList" class="autocomplete-items"></div>
                    </div>
                </div>
                <div class="form-group col-md-4">
                    {{ form.departureDate.label }}:
                    {{ form.departureDate }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.returnDate.label }}:
                    {{ form.returnDate }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.adults.label }}:
                    {{ form.adults }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.children.label }}:
                    {{ form.children }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.infants.label }}:
                    {{ form.infants }}
                </div>
                <div class="form-group col-md-12 text-center">
                    <button type="submit" class="btn btn-primary">Найти билеты</button>
                </div>
            </div>
            <div class="sorting-options">
                <div class="sorting-header">
                    <h5>Параметры сортировки и фильтрации</h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleSortingOptions">
                        <i class="fas fa-chevron-down"></i> Показать опции
                    </button>
                </div>
                <div class="sorting-body" id="sortingBody">
                    <div class="form-group col-md-3">
                        {{ form.sortParam.label }}
                        {{ form.sortParam }}
                        <!--<label for="sortBy">Сортировать по:</label>
                        <select class="form-control" id="sortBy" name="sortBy">
                            <option value="price_asc">Цена (по возрастанию)</option>
                            <option value="price_desc">Цена (по убыванию)</option>
                            <option value="duration_asc">Длительность (короче)</option>
                            <option value="duration_desc">Длительность (дольше)</option>
                            <option value="departure_asc">Время вылета (раньше)</option>
                            <option value="departure_desc">Время вылета (позже)</option>
                        </select>-->
                    </div>
                    <div class="form-group col-md-3">
                        {{ form.maxPrice.label }}:
                        {{ form.maxPrice }}
                    </div>
                    <div class="form-group col-md-3">
                        {{ form.nonStop.label }}:
                        {{ form.nonStop }}
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="row" id="flightResults">
        {% for offer in offers %}
        <div class="flight-card">
            <div class="flight-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="flight-price">{{offer.totalPrice}} {{offer.currencyCode}}</span>
                </div>
                <div>
                    <span class="badge badge-info">Общее время: {{offer.duration|time:"H:i"}}</span>
                </div>
            </div>
            <div class="flight-body">
                {% for segment in segments %}
                {% if segment.offer.id == offer.id %}
                <p class="flight-segment">
                    <div class="d-flex align-items-center">
                        <div class="w-100">
                            <div class="context-segment">
                                <div>
                                    <strong>{{segment.dep_dateTime|date:"d.m.Y H:i"}}</strong> 
                                    <!--<span class="text-muted">{{segment.dep_airport}}</span>-->
                                </div>
                                <div class="flight-duration text-center">
                                    <div class="small text-muted">Длительность</div>
                                    <div>{{segment.duration}}</div>
                                </div>
                                <div class="text-right">
                                    <strong>{{segment.arr_dateTime|date:"d.m.Y H:i"}}</strong> 
                                    <!--<span class="text-muted">{{segment.arr_airport}}</span>-->
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 2px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <div>{{segment.dep_airport}}</div>
                                <div>{{segment.airlineRaiting.airline_code}} Райтинг: {{segment.airlineRaiting.rating}}</div>
                                <div>{{segment.arr_airport}}</div>
                            </div>
                        </div>
                    </div>
                </p>
                {% endif %}
                {% endfor %}
                {% if offer.flightRequest.returnDate %}
                <p>
                    Маршрут обратно:
                </p>
                {% endif %}
                {% for segment in return_segments %}
                {% if segment.offer.id == offer.id %}
                <p class="flight-segment">
                    <div class="d-flex align-items-center">
                        <div class="w-100">
                            <div class="context-segment">
                                <div>
                                    <strong>{{segment.dep_dateTime|date:"d.m.Y H:i"}}</strong> 
                                    <!--<span class="text-muted">{{segment.dep_airport}}</span>-->
                                </div>
                                <div class="flight-duration text-center">
                                    <div class="small text-muted">Длительность</div>
                                    <div>{{segment.duration}}</div>
                                </div>
                                <div class="text-right">
                                    <strong>{{segment.arr_dateTime|date:"d.m.Y H:i"}}</strong> 
                                    <!--<span class="text-muted">{{segment.arr_airport}}</span>-->
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 2px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <div>{{segment.dep_airport}}</div>
                                <div>{{segment.arr_airport}}</div>
                            </div>
                        </div>
                    </div>
                </p>
                {% endif %}
                {% endfor %}
                <div class="text-center mt-3">
                    <a href="/booking/{{offer.id}}/" class="btn book-button">
                        Оформить
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>


<script src="{% static 'flights/js/search.js' %}"></script>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\templates\flights\test.html
=============================
const offerId = window.location.pathname.split('/').filter(Boolean).pop();
        const loadingOverlay = document.getElementById('loadingOverlay');
        const flightDetailsContainer = document.getElementById('flightDetails');
        
        // Показываем оверлей загрузки
        loadingOverlay.style.display = 'flex';
        
        // Получаем актуальную цену и детали рейса
        
        fetch(`/api/check-price/${offerId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    flightDetailsContainer.innerHTML = `<div class="alert alert-danger">Ошибка при получении данных о рейсе: ${data.error}</div>`;
                    return;
                }
                
                // Получаем детали рейса
                return fetch(`/api/flight-offers/`)
                    .then(response => response.json())
                    .then(offersData => {
                        const offer = offersData.offers.find(o => o.id == offerId);
                        if (!offer) {
                            throw new Error('Рейс не найден');
                        }
                        
                        // Обновляем цену из актуальных данных
                        offer.totalPrice = data.totalPrice;
                        
                        // Обновляем скрытое поле с актуальной ценой
                        document.getElementById('actualPrice').value = data.totalPrice;
                        
                        return offer;
                    });
            })
            .then(offer => {
                // Скрываем оверлей загрузки
                loadingOverlay.style.display = 'none';
                
                // Отображаем детали рейса
                let segmentsHtml = '';
                offer.outbound.forEach(segment => {
                    segmentsHtml += `
                        <div class="flight-segment">
                            <div class="d-flex align-items-center">
                                <img src="${segment.airlineLogo}" alt="${segment.airline}" class="airline-logo">
                                <div>
                                    <strong>${segment.departureDateTime.substr(11, 5)}</strong> ${segment.departureAirport} (${segment.departureCity})
                                    <span class="flight-arrow">→</span>
                                    <strong>${segment.arrivalDateTime.substr(11, 5)}</strong> ${segment.arrivalAirport} (${segment.arrivalCity})
                                    <div class="flight-duration">Продолжительность: ${segment.duration}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                flightDetailsContainer.innerHTML = `
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Информация о рейсе</h5>
                        </div>
                        <div class="card-body">
                            <!-- Уведомление об изменении цены -->
                            <div id="priceAlert" class="alert alert-warning d-none mb-3">
                                <h6 class="alert-heading">Внимание! Цена изменилась</h6>
                                <p>Первоначальная цена: <span id="originalPrice"></span></p>
                                <p>Новая цена: <strong id="totalPrice">${offer.totalPrice} ${offer.currencyCode}</strong> <span id="priceDifference" class="ml-2"></span></p>
                                <p class="mb-0">Цены на авиабилеты динамические и могут меняться в зависимости от спроса и наличия мест.</p>
                                <hr>
                                <button id="acceptNewPrice" class="btn btn-sm btn-primary">Продолжить с новой ценой</button>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-1">${offer.origin} → ${offer.destination}</h6>
                                    <p class="text-muted mb-0">${offer.departureDate} {% if offer.returnDate %} - {{ offer.returnDate }}{% endif %}</p>
                                </div>
                                <div>
                                    <span class="h4 text-success" id="totalPrice">${offer.totalPrice} ${offer.currencyCode}</span>
                                </div>
                            </div>
                            ${segmentsHtml}
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                loadingOverlay.style.display = 'none';
                flightDetailsContainer.innerHTML = `<div class="alert alert-danger">Ошибка при загрузке данных о рейсе: ${error.message}</div>`;
            });

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\admin.py
=============================
from django.contrib import admin
from .models import FlightOffer, FlightRequest, FlightSegment, Booking, AirLineRaiting

# Register your models here.

admin.site.register(FlightOffer)
admin.site.register(FlightRequest)
admin.site.register(FlightSegment)
admin.site.register(Booking)
admin.site.register(AirLineRaiting)

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\apps.py
=============================
from django.apps import AppConfig


class FlightsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'flights'

    # def ready(self):
    #     # if not os.environ.get('RUN_MAIN'):
    #     #     return
    #     from . import tasks
    #     tasks.DeleteReq().start_scheduler()

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\forms.py
=============================
from django import forms
from .models import FlightRequest


class OfferSearchForm(forms.ModelForm):
    CURRENCY_CODES = [('EUR', '€'), ('RUB', '₽'), ('USD', '$')]

    currencyCode = forms.ChoiceField(choices=CURRENCY_CODES, initial='RUB', label='Валюта', widget=forms.Select())
    # returnDate = forms.DateField(required=False)
    
    # Добавляем виджеты для выбора количества пассажиров с ограничениями
    '''
    adults = forms.IntegerField(
        min_value=1, 
        max_value=9, 
        label='Взрослые (от 12 лет)',
        widget=forms.NumberInput(attrs={'class': 'form-control', 'min': '1', 'max': '9'})
    )
    children = forms.IntegerField(
        min_value=0, 
        max_value=9, 
        required=False,
        label='Дети (от 2 до 12 лет)',
        widget=forms.NumberInput(attrs={'class': 'form-control', 'min': '0', 'max': '9'})
    )
    infants = forms.IntegerField(
        min_value=0, 
        max_value=9, 
        required=False,
        label='Младенцы (до 2 лет)',
        widget=forms.NumberInput(attrs={'class': 'form-control', 'min': '0', 'max': '9'})
    )
    '''
    class Meta:
        model = FlightRequest
        fields = '__all__'
        labels = {
            'currencyCode': "Валюта",
            'originLocationCode': 'Аэропорт отправления',
            'destinationLocationCode': 'Аэропорт прибытия',
            'departureDate': 'Дата отправления',
            'returnDate': 'Дата возвращения',
            'maxPrice': 'Максимальная цена',
            'nonStop': 'В первую очередь без пересадок',
            'adults': 'Взрослые от 12',
            'children': 'Дети до 12',
            'infants': 'Младенцы до 2',
            'sortParam': 'Сортировать по'
        }
        widgets = {
            'departureDate': forms.DateInput(attrs={'type': 'date','class': 'form-control', 'style': 'width:10em;'}),
            'returnDate': forms.DateInput(attrs={'type': 'date', 'class': 'form-control', 'style': 'width:10em;'}),
            'originLocationCode': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Например, JFK', }),
            'destinationLocationCode': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Например, LAX', }),
            'currencyCode': forms.Select(attrs={'class': 'form-control'}),
            'maxPrice': forms.NumberInput(attrs={'class': 'form-control', 'placeholder': 'Без ограничений'}),
            'nonStop': forms.CheckboxInput(),
            'adults': forms.NumberInput(attrs={'class': 'form-control', 'min': '1', 'max': '9', 'size': '1', 'maxlength': '1', 'style': 'width:3em;'}),
            'children': forms.NumberInput(attrs={'class': 'form-control', 'min': '1', 'max': '9', 'size': '1', 'maxlength': '1', 'style': 'width:3em;'}),
            'infants': forms.NumberInput(attrs={'class': 'form-control', 'min': '1', 'max': '9', 'size': '1', 'maxlength': '1', 'style': 'width:3em;'}),
            'sortParam': forms.Select(attrs={'class': 'form-control'})
        }


# class OfferSearchForm(forms.Form):
#     CURRENCY_CODES = [('EUR', '€'), ('RUB', '₽'), ('USD', '$')]
#
#     currencyCode = forms.ChoiceField(choices=CURRENCY_CODES, label='Валюта', initial='EUR', widget=forms.Select())
#     originLocationCode = forms.CharField(max_length=100)
#     # originLC = forms.ChoiceField(choices=[], label='Выбирете аэропорт отправления')
#     destinationLocationCode = forms.CharField(max_length=100)
#     # destinationLC = forms.ChoiceField(choices=[], label='Выбирете аэропорт прибытия')
#     departureDate = forms.DateField(label='Дата отправления', widget=forms.SelectDateWidget())
#     returnDate = forms.DateField(label='Дата возвращения', widget=forms.SelectDateWidget(), required=False)
#     adults = forms.IntegerField(label='Количество взрослых пассажиров')


=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\models.py
=============================
from django.db import models
from user_management.models import CustomUser as User
import datetime

# Create your models here.


class FlightRequest(models.Model):
    SORT_PARMS = (('price_asc', 'Цене'), ('duration_asc', 'Длительности'), ('departure_asc', 'Времени вылета'))
    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
    session_key = models.CharField(max_length=40, blank=True)  # Для хранения ключа сессии
    currencyCode = models.CharField(max_length=50)
    originLocationCode = models.CharField(max_length=50)
    destinationLocationCode = models.CharField(max_length=50)
    departureDate = models.DateField()
    returnDate = models.DateField(null=True, blank=True)
    adults = models.IntegerField(default=1)
    children = models.IntegerField(null=True, blank=True)
    infants = models.IntegerField(null=True, blank=True)
    cabin = models.CharField(max_length=20, null=True, blank=True)
    includedAirlines = models.CharField(max_length=200, null=True, blank=True)
    excludedAirlines = models.CharField(max_length=200, null=True, blank=True)
    travelClass = models.CharField(max_length=50, null=True, blank=True)
    nonStop = models.BooleanField(null=True, blank=True)
    maxPrice = models.IntegerField(null=True, blank=True)
    sortParam = models.CharField(max_length=50, choices=SORT_PARMS, default='price_asc')
    created_at = models.DateTimeField(auto_now_add=True)  # Новое поле для времени создания


class FlightOffer(models.Model):
    flightRequest = models.ForeignKey(FlightRequest, on_delete=models.CASCADE)
    adults_count = models.IntegerField()
    children_count = models.IntegerField(null=True, blank=True)
    infants_count = models.IntegerField(null=True, blank=True)
    dep_duration = models.DateTimeField()
    arr_duration = models.DateTimeField(default=None, null=True, blank=True)
    duration = models.TimeField()
    currencyCode = models.CharField(max_length=3)
    totalPrice = models.DecimalField(max_digits=10, decimal_places=2)
    oneWay = models.BooleanField(default=False)
    data = models.JSONField()


class FlightSegment(models.Model):
    offer = models.ForeignKey(FlightOffer, on_delete=models.CASCADE)
    there_seg = models.BooleanField(default=True)
    dep_iataCode = models.CharField(max_length=3)
    dep_airport = models.CharField(max_length=50)
    dep_terminal = models.CharField(max_length=2, null=True)
    dep_dateTime = models.DateTimeField()
    arr_iataCode = models.CharField(max_length=3)
    arr_airport = models.CharField(max_length=50)
    arr_terminal = models.CharField(max_length=2, null=True)
    arr_dateTime = models.DateTimeField()
    carrierCode = models.CharField(max_length=2)
    airlineRaiting = models.ForeignKey('AirLineRaiting', on_delete=models.SET_NULL, null=True, blank=True)
    number = models.CharField(max_length=4, null=True)
    aircraftCode = models.CharField(max_length=4, null=True)
    operating = models.CharField(max_length=2, null=True)
    duration = models.TimeField()
    # id_seg = models.CharField(max_length=2)


class Booking(models.Model):
    STATUS_CHOICES = (
        ('PENDING', 'Ожидает подтверждения'),
        ('CONFIRMED', 'Подтверждено'),
        ('CANCELLED', 'Отменено'),
    )
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
    session_key = models.CharField(max_length=40, blank=True)  # Для неавторизованных пользователей
    offer = models.ForeignKey(FlightOffer, on_delete=models.CASCADE)
    order_id = models.CharField(max_length=50, blank=True)  # ID заказа в Amadeus
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='PENDING')
    total_price = models.DecimalField(max_digits=10, decimal_places=2)
    currency_code = models.CharField(max_length=3)
    
    # Информация о пассажирах
    passenger_data = models.JSONField(default=dict)  # Хранит информацию о пассажирах в формате JSON
    
    # Контактная информация
    contact_email = models.EmailField()
    contact_phone = models.CharField(max_length=20)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"Бронирование #{self.id} - {self.status}"
    

class AirLineRaiting(models.Model):
    airline_code = models.CharField(max_length=10, blank=True, null=True)
    airline_name = models.CharField(max_length=100)
    rating = models.FloatField()

    def __str__(self):
        return f"{self.airline_name} ({self.airline_code}) - Рейтинг: {self.rating}"


=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\scheduler_jobs.py
=============================
from .models import FlightRequest
import datetime


def delete_req():
    print("Hello world")
    delete_time = (datetime.datetime.now() - datetime.timedelta(minutes=1))
    FlightRequest.objects.filter(create_in__lte=delete_time).delete()


=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\tasks.py
=============================
from apscheduler.schedulers.background import BackgroundScheduler
from django_apscheduler.jobstores import DjangoJobStore
from .models import FlightRequest
import datetime
from .scheduler_jobs import delete_req


# def start_scheduler():
#     scheduler = BackgroundScheduler()
#     scheduler.add_jobstore(DjangoJobStore(), "default")
#
#     scheduler.add_job(
#         delete_req,  # Указываем глобальную функцию
#         'interval',
#         minutes=5,
#         id="delete_req",
#     )
#     scheduler.start()


class DeleteReq:
    def __init__(self):
        self.scheduler = BackgroundScheduler()
        self.scheduler.add_jobstore(DjangoJobStore(), "default")

    def start_scheduler(self):
        self.scheduler.add_job(
            delete_req,
            'interval',
            minutes=2,
            id="my_job",
            replace_existing=True,
        )
        self.scheduler.start()

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\tests.py
=============================
from django.test import TestCase

# Create your tests here.

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\urls.py
=============================
from django.urls import path, include
from .views import OffersSearch, recommendations_view, index
from api.views import get_cities

app_name = 'flights'

urlpatterns = [
    path('', OffersSearch.as_view(), name='home'),
    path('api_airport_search/', get_cities, name='api_airport_search'),
    path('recommendations/<int:user_id>/', recommendations_view, name='recommendations'),
    #path('clear-search-history/', ClearSearchHistoryView.as_view(), name='clear_search_history'),
    #path('booking/<int:offer_id>/', BookingView.as_view(), name='booking'),
    #path('booking/success/<int:booking_id>/', BookingSuccessView.as_view(), name='booking_success'),
]

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\views.py
=============================
from django.shortcuts import render, get_object_or_404
from .forms import OfferSearchForm
from django.shortcuts import render, redirect, HttpResponseRedirect, reverse, HttpResponse
from .models import FlightOffer, FlightRequest, FlightSegment, AirLineRaiting
from user_management.models import CustomUser as User
from django.contrib.auth.models import Group
from api.models import IATA
from django.views.generic.edit import CreateView, View, FormView
from django.views.generic import TemplateView
from django.utils import timezone
import amadeus
from django.http import JsonResponse
import datetime
import json
from api.views import get_cities, offer_search_api
import pandas as pd


def index(request):
    #data = pd.read_csv('Airline_review.csv')

    #data['Overall_Rating'] = pd.to_numeric(data['Overall_Rating'], errors='coerce')

    #result = data.groupby('Airline Name')['Overall_Rating'].mean().reset_index()
    #print(result)
    #for index, row in result.iterrows():
        #AirLineRaiting(airline_code=None, airline_name=row['Airline Name'], rating=row['Overall_Rating']).save()
    #print(IATA.objects.get(id=100).iata)
    #IATA.objects.all().delete()
    #iata = IATA.objects.get(city='The Bronx') 
    #IATA.objects.filter(id__lt=9804).delete()
    #for i in range(0, len(data)):
        #IATA(id=i + 1 ,iata=data['IATA'][i], name=data['Airport name'][i], city=data['City'][i], state=data['Country'][i]).save()
    return render(request, 'flights/search.html')

    

class OffersSearch(FormView):
    template_name = 'flights/search.html'
    form_class = OfferSearchForm
    success_url = '/'

    def get_initial(self):
        # Получаем начальные значения для формы из последнего поискового запроса пользователя
        initial = super().get_initial()
    
        # Проверяем наличие сессии
        if not self.request.session.session_key:
            self.request.session.create()
            
        session_key = self.request.session.session_key
        
        # Ищем последний поисковый запрос для текущей сессии
        last_request = FlightRequest.objects.filter(
            session_key=session_key
        ).order_by('-created_at').first()

        if last_request:
            # Заполняем форму данными из последнего запроса
            for field in ['originLocationCode', 'destinationLocationCode', 'departureDate', 
                         'returnDate', 'adults', 'children', 'infants', 'currencyCode',
                         'cabin', 'includedAirlines', 'excludedAirlines', 'travalClass',
                         'nonStop', 'maxPrice']:
                if hasattr(last_request, field) and getattr(last_request, field) is not None:
                    initial[field] = getattr(last_request, field)
        #else:
            #initial['departureDate'] = datetime.date.today()
            #initial['returnDate'] = datetime.date.today() + datetime.timedelta(days=7)

        return initial
    
    def form_valid(self, form):
        flight_request = form.save(commit=False)
        
        # Проверяем наличие сессии

        if not self.request.session.session_key:
            self.request.session.create()
            
        # Сохраняем данные пользователя и сессии
        if self.request.user.is_authenticated:
            flight_request.user = self.request.user
        flight_request.session_key = self.request.session.session_key  # Новое поле
        
        # Обрабатываем коды аэропортов
        flight_request.originLocationCode = flight_request.originLocationCode[:3].upper()
        flight_request.destinationLocationCode = flight_request.destinationLocationCode[:3].upper()

        
        # Сохраняем запрос и устанавливаем его ID в сессию
        flight_request.save()
        self.request.session['id_offer_search'] = flight_request.id
        

        search_success = offer_search_api(flight_request.id)
        
        if self.request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': search_success})
        
        return HttpResponseRedirect(reverse('flights:home'))

    def form_invalid(self, form):
        if self.request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': False, 'errors': form.errors})
        return HttpResponse(form.errors, status=400)#render(self.request, self.template_name, {'form': form})

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Получаем результаты последнего поиска
        if 'id_offer_search' in self.request.session:
            try:
                flight_req = FlightRequest.objects.filter(id=self.request.session['id_offer_search']).last()
                if flight_req:
                    context['offers'] = get_offers(flight_req)
                    context['segments'] = FlightSegment.objects.filter(there_seg=True)
                    context['return_segments'] = FlightSegment.objects.filter(there_seg=False)
                    context['last_search'] = flight_req
            except Exception as e:
                # Логируем ошибку, но не позволяем ей прервать выполнение
                print(f"Ошибка при получении результатов поиска: {e}")
                # Удаляем некорректный ID из сессии
                if 'id_offer_search' in self.request.session:
                    del self.request.session['id_offer_search']
                    self.request.session.save()
        
        return context


def get_offers(request):
    #request = FlightRequest.objects.filter(id=id_request).last()
    sort_parm = request.sortParam
    match sort_parm:
        case 'price_asc':
            parm = 'totalPrice'
        case 'duration_asc':
            parm = 'duration'
        case 'departure_asc':
            parm = 'dep_duration'
    if request.nonStop:
        return FlightOffer.objects.filter(flightRequest=request).order_by('-oneWay', parm)[:6]
    else:
        return FlightOffer.objects.filter(flightRequest=request).order_by(parm)[:6]

from django.shortcuts import render
from django.http import JsonResponse, Http404
from django.conf import settings
import os

# Adjust the model class import to match your training script's model class
from flights.recsys.predictor import Recommender
# Provide the same model class signature as used during training
from flights.recsys.model_stub import RecModelForInference as ModelClass

# Lazy init (keeps memory in process for faster inference)
RECOMMENDER = None

def get_recommender():
    global RECOMMENDER
    if RECOMMENDER is None:
        model_path = getattr(settings, 'RECSYS_MODEL_PATH', os.path.join(settings.BASE_DIR, 'recsys_model.pth'))
        data_dir = getattr(settings, 'RECSYS_DATA_DIR', os.path.join(settings.BASE_DIR, 'recsys_data'))
        RECOMMENDER = Recommender(ModelClass, model_state_path=model_path, data_dir=data_dir)
    return RECOMMENDER


def recommendations_view(request, user_id):
    # returns JSON list of recommended item IDs
    try:
        rec = get_recommender()
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)

    try:
        top = rec.recommend_for_user(user_id, top_k=10)

        data = []

        for i in top:
            offer = FlightOffer.objects.get(id=i)
            item = {
                'iataCode': FlightSegment.objects.filter(offer=offer).last().dep_iataCode,
                'cityName': FlightSegment.objects.filter(offer=offer).last().dep_airport
            }
            data.append(item)

    except Exception as e:
        return JsonResponse({'error': str(e)}, status=400)

    # You can also render a template and pass item objects to it
    return JsonResponse({'user_id': user_id, 'data': data})

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\flights\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\migrations\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\static\user_management\style.css
=============================
.container {
            display: flex;
            justify-content: left;
            align-items: left;
            height: 100vh;
            background-color: rgb(205, 92, 92);}
        .card {
            background-color: #808080;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            transition: 0.3s;
            border-radius: 5px;
            padding: 50px 20px;
        }

        .btn {
            background-color: #FFFFFF;
            color: black;
            padding: 10px 20px;
            border: none;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            }

        button {
            background-color: #FFFFFF;
            color: black;
            padding: 10px 20px;
            border: none;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        table {
            margin-top: 10px;
            margin-right: 5px;
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #FFFFFF;
            background-color: #FFFFFF;
        }

        input[type=text], textarea {
            background-color: #FFFFFF;
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        select {
            margin: 8px;
            padding: 8px 16px;
        }

header {
            background-color: #100;
            color: black;
            padding: 20px 0;
            text-align: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        nav ul {
            list-style-type: none;
            padding: 0;
            margin: 15px 0 0 0;
        }

        nav ul li {
            display: inline;
            margin: 0 15px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
        }

        nav ul li a:hover {
            text-decoration: underline;
        }


=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\templates\user_management\auth.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Вход в систему - Билеты.ру{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Вход в систему</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="id_username">Email</label>
                            {{ form.username }}
                            {% if form.username.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.username.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="id_password">Пароль</label>
                            {{ form.password }}
                            {% if form.password.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.password.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Войти</button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center">
                    <p class="mb-0">Еще нет аккаунта? <a href="{% url 'user_management:signup' %}">Зарегистрируйтесь</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\templates\user_management\base.html
=============================
<!DOCTYPE html>
{% load static %}

<html lang="ru">
<head>
    <title>{{ title }}</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="{% static 'user_management/style.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    {% block head %}
    {% endblock %}

</head>
<body style="background-color: #FFFFFF">
    <header>
        <nav>
            <ul>
                <li><a href="#">Главная</a></li>
                <li><a href="#">О нас</a></li>
                <li><a href="#">Услуги</a></li>
                <li><a href="#">Контакты</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <div class="card">
                {% block container%} {% endblock %}
            </div>
        </div>
        {% block body %} {% endblock %}
    </main>
</body>
</html>

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\templates\user_management\otp_verify.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Вход в систему - Билеты.ру{% endblock %}

{% block content %}
<div class="card mx-auto">
    <div class="card-body text-center">
        <h3>Введите код</h3>
        <div>
            <form method="POST" action="{% url 'user_management:verify_mfa' user_id %}" class="form text-center">
                {% csrf_token %}
                <div class="form-group text-">
                    <div class="mx-auto" style="width: 30%;">
                        <input type="text" id="otp_code" name="otp_code" maxlength="6" required
                        class="form-control" placeholder="Введите свой код">
                    </div>
                </div>
                <button class="btn btn-primary" type="submit">Отправить</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\templates\user_management\profile.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Профиль - Билеты.ру{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row">
        <!-- Информация о пользователе -->
        <!--<div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Информация о пользователе</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-circle mb-3">
                            <span class="initials">{{ user.first_name|first }}{{ user.last_name|first }}</span>
                        </div>
                        <h4>{{ user.first_name }} {{ user.last_name }}</h4>
                        <p class="text-muted">{{ user.email }}</p>
                    </div>
                    
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Имя пользователя:</span>
                            <span class="badge bg-primary">{{ user.username }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Дата регистрации:</span>
                            <span class="badge bg-secondary">{{ user.date_joined|date:"d.m.Y" }}</span>
                        </li>
                    </ul>
                </div>
                <div class="card-footer">
                    <a href="{% url 'user_management:logout' %}" class="btn btn-danger btn-sm w-100">Выйти из системы</a>
                </div>
            </div>
        </div>
    -->
        <!-- История поисков и бронирований -->
        <div class="col-md-8">   
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Бронирования</h5>
                </div>
                <div class="card-body">
                    {% if orders %}
                    <div class="list-group">
                        {% for o in orders %}
                        <a href="{% url 'booking:booking_data' o.id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ o.offer.flightRequest.originLocationCode }} → {{ o.offer.flightRequest.destinationLocationCode }}</h5>
                                <small>{{ o.created_at|date }}</small>
                            </div>
                            <p class="mb-1">Дата вылета: {{ o.offer.dep_duration }}</p>
                            <p class="mb-1">Статус: {% if o.status == 'PENDING' %} Ожидает подтверждения {% else %} Подтверждено {% endif %}</p>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                        <div class="alert alert-info">
                            У вас пока нет бронирований. <a href="{% url 'flights:home' %}" class="alert-link">Найти рейс</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .avatar-circle {
        width: 100px;
        height: 100px;
        background-color: #007bff;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
    }
    
    .initials {
        font-size: 42px;
        color: #fff;
        font-weight: bold;
        text-transform: uppercase;
    }
</style>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\templates\user_management\qrCodePage.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Вход в систему - Билеты.ру{% endblock %}

{% block content %}
<div class="card mx-auto">
    <div class="card-body text-center">
        <h3>{{ request.user.email }}</h3>
        {% if not request.user.mfa_enabled %}
        <div>
            <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" width="300" height="300">
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\templates\user_management\signup.html
=============================
{% extends 'flights/base.html' %}
{% load static %}

{% block title %}Регистрация - Билеты.ру{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Регистрация нового пользователя</h4>
                </div>
                <div class="card-body">
                    <!--{% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}-->
                    
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_email">Email</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.email.errors }}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">{{ form.email.help_text }}</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_password1">Пароль</label>
                                {{ form.password1 }}
                                {% if form.password1.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.password1.errors }}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">{{ form.password1.help_text }}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_password2">Подтверждение пароля</label>
                                {{ form.password2 }}
                                {% if form.password2.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.password2.errors }}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">{{ form.password2.help_text }}</small>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center">
                    <p class="mb-0">Уже есть аккаунт? <a href="{% url 'user_management:signin' %}">Войдите</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\admin.py
=============================
from django.contrib import admin
from .models import CustomUser as User

# Register your models here.

admin.site.register(User)

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\apps.py
=============================
from django.apps import AppConfig


class MainConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'user_management'

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\forms.py
=============================
from django import forms
from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
from .models import CustomUser as User
#from django.contrib.auth.models import User
from django.core.exceptions import ValidationError


class SignUpForm(UserCreationForm):
    username = forms.EmailField(label='Email', widget=forms.EmailInput(attrs={'autofocus': True}))

    class Meta:
        model = User
        fields = ('username', 'password1', 'password2')
    '''
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if User.objects.filter(email=email).exists():
            raise ValidationError('Пользователь с таким email уже существует.')
        return email
    '''


class CustomUserCreationForm(UserCreationForm):
    email = forms.EmailField(required=True)
    
    class Meta:
        model = User
        fields = ('email', 'password1', 'password2')
    
    def save(self, commit=True):
        # Переопределяем save для дополнительной логики
        user = super().save(commit=False)
        user.email = self.cleaned_data['email']
        
        if commit:
            user.save()
        return user


class SignInForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ('email', 'password')
        widgets = {
            'password': forms.PasswordInput(),
            'email': forms.EmailInput(attrs={'autofocus': True}),
        }

class EmailAuthenticationForm(AuthenticationForm):
    username = forms.EmailField(label='Email', widget=forms.EmailInput(attrs={'autofocus': True}))

    class Meta:
        model = User
        fields = ('username', 'password')

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\models.py
=============================
from django.db import models
from django.contrib.auth.models import AbstractUser, BaseUserManager

# Create your models here.
class CustomUserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        """
        Создает и возвращает пользователя с email, паролем и дополнительными полями
        """
        if not email:
            raise ValueError('Email обязателен для создания пользователя')
        
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        """
        Создает и возвращает суперпользователя с email и паролем
        """
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('is_active', True)

        if extra_fields.get('is_staff') is not True:
            raise ValueError('Суперпользователь должен иметь is_staff=True')
        if extra_fields.get('is_superuser') is not True:
            raise ValueError('Суперпользователь должен иметь is_superuser=True')

        return self.create_user(email, password, **extra_fields)
    
    
class CustomUser(AbstractUser):
    username = None
    email = models.EmailField(unique=True)

    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []

    objects = CustomUserManager()

    mfa_secret = models.CharField(max_length=32, blank=True, null=True)
    mfa_enabled = models.BooleanField(default=False)

    def __str__(self):
        return self.email
    
    

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\tests.py
=============================
from django.test import TestCase

# Create your tests here.

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\urls.py
=============================
from django.urls import path, include
from .views import SignUpView, SignInView, LogOutView, profile, qrCodePage, verify_mfa

app_name = 'user_management'

urlpatterns = [
    path('signup/', SignUpView.as_view(), name='signup'),
    path('signin/', SignInView.as_view(), name='signin'),
    path('logout/', LogOutView.as_view(), name='logout'),
    path('profile/', profile, name='profile'),
    path('qrCodePage/', qrCodePage, name='qrCodePage'),
    path('verify_mfa/<int:user_id>', verify_mfa, name='verify_mfa')
]

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\views.py
=============================
from django.shortcuts import render, redirect, HttpResponseRedirect, reverse, HttpResponse
from django.contrib.auth.forms import AuthenticationForm, UserCreationForm
from django.views.generic.edit import CreateView, View, FormView
from .models import CustomUser as User
from .forms import SignUpForm, SignInForm, EmailAuthenticationForm, CustomUserCreationForm
from django.contrib.auth import authenticate, login, logout
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.urls import reverse_lazy
from flights.models import Booking
import pyotp
import qrcode
import io
import base64

# Create your views here.


def verify_2fa_otp(user, otp):
    totp = pyotp.TOTP(user.mfa_secret)
    if totp.verify(otp):
        user.mfa_enabled = True
        user.save()
        return True
    return False

class SignUpView(CreateView):
    template_name = 'user_management/signup.html'
    form_class = CustomUserCreationForm
    success_url = reverse_lazy('flights:home')
    
    def get(self, request, *args, **kwargs):
        if request.user.is_authenticated:
            return HttpResponseRedirect(reverse('flights:home'))
        else:
            return super().get(request, *args, **kwargs)

    def form_valid(self, form):
        # Автоматически авторизуем пользователя после регистрации
        if form.is_valid():
            user = form
            user.save()
            user = authenticate(self.request, username=form.cleaned_data.get('email'), password=form.cleaned_data.get('password1'))
            login(self.request, user)
            return super().form_valid(form)
        else:
            return self.form_invalid(form)

    def form_invalid(self, form):
        messages.error(self.request, 'Пожалуйста, исправьте ошибки в форме.')
        return super().form_invalid(form)


class SignInView(FormView):
    template_name = 'user_management/auth.html'
    form_class = EmailAuthenticationForm
    success_url = reverse_lazy('flights:home')
    
    def get(self, request, *args, **kwargs):
        if request.user.is_authenticated:
            messages.info(request, 'Вы уже вошли в систему.')
            return redirect('flights:home')
        else:
            return super().get(request, *args, **kwargs)
    
    def form_valid(self, form):
        #form = EmailAuthenticationForm(self.request, data=self.request.POST)
        print(User.objects.all())
        if form.is_valid():
            user = form.get_user()
            print(user.mfa_enabled)
            if user.mfa_enabled:
                return redirect('user_management:verify_mfa', user_id=user.id)
            login(self.request, user)
            messages.success(self.request, f'Добро пожаловать!')
            return super().form_valid(form)
        return self.form_invalid(form)
        username = form.cleaned_data.get('email')
        password = form.cleaned_data.get('password')
        print(form.cleaned_data)
        user = authenticate(self.request, username=username, password=password)
        print(user)
        if user is not None:
            if user.mfa_enabled:
                return redirect('user_management:verify_mfa', user_id=user.id)
            login(self.request, user)
            messages.success(self.request, f'Добро пожаловать!')
            return super().form_valid(form)
        else:
            #messages.error(self.request, 'Неверное имя пользователя или пароль.')
            return self.form_invalid(form)

    def form_invalid(self, form):
        print(User.objects.all())
        messages.error(self.request, 'Неверное имя пользователя или пароль.')
        return super().form_invalid(form)


class LogOutView(View):
    def get(self, request):
        logout(request)
        messages.success(request, 'Вы успешно вышли из системы.')
        return redirect('flights:home')


@login_required
def profile(request):
    orders = Booking.objects.filter(user=request.user).order_by('-created_at')[:10]
    print(orders)
    context = {
        'user': request.user,
        'orders': orders
    }
    return render(request, 'user_management/profile.html', context)


@login_required
def qrCodePage(request):
    user = request.user
    if not user.mfa_secret:
        user.mfa_secret = pyotp.random_base32()
        user.save()
    otp_uri = pyotp.totp.TOTP(user.mfa_secret).provisioning_uri(
        name=user.email,
        issuer_name='Bilety.ru'
    )
    print(user.mfa_secret)
    qr = qrcode.QRCode(version=1, box_size=10, border=5, error_correction=qrcode.constants.ERROR_CORRECT_L)
    qr.add_data(otp_uri)
    qr.make(fit=True)
    qr_img = qr.make_image(fill_color="black", back_color="white")
    buffered = io.BytesIO()
    qr_img.save('user_management/static/user_management/qr_code.png')
    qr_img.save(buffered, format="PNG")
    qr_code = base64.b64encode(buffered.getvalue()).decode()
    

    qr_code_data_uri = f"data:image/png;base64,{qr_code}"

    return render(request, 'user_management/qrCodePage.html', {'qr_code': qr_code})


def verify_mfa(request, user_id):
    if request.method == 'POST':
        otp = request.POST.get('otp_code')
        if not user_id:
            messages.error(request, 'Неверный id пользователя')
            return render(request, 'user_management/otp_verify.html', {'user_id': user_id})
        user = User.objects.get(id=user_id)
        if verify_2fa_otp(user, otp):
            if request.user.is_authenticated:
                messages.success(request, '2-х факторная аутентификация включена!')
                return redirect('flights:home')
            login(request, user)
            messages.success(request, 'Вы вошли!')
            return redirect('flights:home')
        else:
            messages.error(request, 'Неверный код')
            if request.user.is_authenticated:
                return redirect('flights:home')
            return render(request, 'user_management/otp_verify.html', {'user_id': user_id})
            
    return render(request, 'user_management/otp_verify.html', {'user_id': user_id})

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\user_management\__init__.py
=============================

=============================
FILE: D:\VS_code_projects\bilety_ru\bilety_ru\manage.py
=============================
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bilety_ru.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

